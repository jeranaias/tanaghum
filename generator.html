<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Generate Arabic comprehension lessons with synchronized audio and text">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://tanaghum.app/generator.html">

  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="Generate Lesson | Tanaghum">
  <meta property="og:description" content="Generate Arabic comprehension lessons with synchronized audio and text">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://tanaghum.app/generator.html">
  <meta property="og:site_name" content="Tanaghum">

  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Generate Lesson | Tanaghum">
  <meta name="twitter:description" content="Generate Arabic comprehension lessons with synchronized audio and text">

  <title>Generate Lesson | Tanaghum</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Naskh+Arabic:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/generator.css">
  <link rel="stylesheet" href="css/export-dialog.css">
</head>
<body>
  <!-- Skip Navigation Link -->
  <a href="#main-content" class="skip-link" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;z-index:9999;padding:1rem;background:#1a73e8;color:#fff;text-decoration:none;">Skip to main content</a>

  <!-- Header -->
  <header class="header" role="banner">
    <div class="header-inner">
      <a href="index.html" class="logo">
        <span class="logo-arabic" lang="ar">تناغم</span>
        <span>Tanaghum</span>
      </a>
      <nav class="nav" aria-label="Main navigation">
        <a href="index.html" class="nav-link">Home</a>
        <a href="generator.html" class="nav-link active" aria-current="page">Generate</a>
        <a href="gallery.html" class="nav-link">Gallery</a>
        <a href="about.html" class="nav-link">About</a>
      </nav>
    </div>
  </header>

  <!-- Three-Panel Layout -->
  <main class="generator-layout" id="main-content">
    <!-- Left Panel: Configuration -->
    <aside class="panel panel-left" id="config-panel" aria-label="Lesson configuration">
      <!-- Content Source -->
      <div class="panel-section">
        <h3 class="section-title" id="source-heading">Content Source</h3>

        <div class="source-tabs" role="tablist" aria-labelledby="source-heading">
          <button class="source-tab active" data-source="youtube" role="tab" aria-selected="true" aria-controls="source-youtube" id="tab-youtube" type="button">
            <span class="tab-icon" aria-hidden="true">&#128250;</span>
            <span class="tab-label">YouTube URL</span>
            <span class="tab-desc">Paste any Arabic video</span>
          </button>

          <button class="source-tab" data-source="upload" role="tab" aria-selected="false" aria-controls="source-upload" id="tab-upload" type="button">
            <span class="tab-icon" aria-hidden="true">&#128193;</span>
            <span class="tab-label">Upload Audio</span>
            <span class="tab-desc">MP3, WAV, M4A (max 10 min)</span>
          </button>

          <button class="source-tab" data-source="search" role="tab" aria-selected="false" aria-controls="source-search" id="tab-search" type="button">
            <span class="tab-icon" aria-hidden="true">&#128269;</span>
            <span class="tab-label">Smart Search</span>
            <span class="tab-desc">Find Arabic content for you</span>
          </button>
        </div>

        <!-- YouTube Input -->
        <div class="source-content" id="source-youtube" role="tabpanel" aria-labelledby="tab-youtube">
          <div class="form-group">
            <label class="form-label" for="youtube-url">YouTube URL</label>
            <input type="url" id="youtube-url" class="form-input"
                   placeholder="https://youtube.com/watch?v=..."
                   pattern="https?://(www\.)?(youtube\.com|youtu\.be)/.+"
                   aria-describedby="youtube-hint">
            <p class="form-hint" id="youtube-hint">Works with any Arabic video that has captions</p>
          </div>
        </div>

        <!-- Upload Input -->
        <div class="source-content hidden" id="source-upload" role="tabpanel" aria-labelledby="tab-upload">
          <div id="drop-zone" class="drop-zone" role="button" tabindex="0" aria-label="Upload audio file. Drag and drop or click to upload">
            <span class="drop-icon" aria-hidden="true">&#128193;</span>
            <span>Drag & drop or click to upload</span>
            <input type="file" id="file-input" hidden
                   accept=".mp3,.wav,.m4a,.ogg,.webm,.aac,audio/*"
                   aria-label="Select audio file">
          </div>
          <div id="file-preview" class="file-preview hidden" role="status" aria-live="polite">
            <span aria-hidden="true">&#127925;</span>
            <div class="file-info">
              <div class="file-name" id="file-name"></div>
              <div class="file-size" id="file-size"></div>
            </div>
            <button class="file-remove" id="file-remove" type="button" aria-label="Remove file">&times;</button>
          </div>
        </div>

        <!-- Smart Search Input -->
        <div class="source-content hidden" id="source-search" role="tabpanel" aria-labelledby="tab-search">
          <div class="form-group">
            <label class="form-label" for="search-query">Search for Arabic Content</label>
            <div class="search-input-wrapper" role="search">
              <input type="search" id="search-query" class="form-input"
                     placeholder="e.g., أخبار الاقتصاد, مقابلة سياسية, وثائقي..."
                     aria-describedby="search-hint"
                     autocomplete="off">
              <button class="search-btn" id="search-btn" type="button" aria-label="Search">
                <span aria-hidden="true">&#128269;</span>
              </button>
            </div>
            <p class="form-hint" id="search-hint">Enter a topic in Arabic or English to find suitable content</p>
          </div>

          <!-- AI Suggest Button -->
          <button class="btn btn-secondary btn-sm" id="ai-suggest-btn" style="margin-bottom: 12px; width: 100%;">
            <span>&#10024;</span> AI Suggest Queries for My Level
          </button>

          <!-- Suggested Queries -->
          <div id="suggested-queries" class="suggested-queries hidden">
            <!-- AI-generated query suggestions -->
          </div>

          <!-- Search Results -->
          <div id="search-results" class="video-search-results hidden">
            <div class="search-results-header">
              <span id="search-results-count">0 videos found</span>
              <button class="btn btn-ghost btn-sm" id="clear-search">Clear</button>
            </div>
            <div id="search-results-grid" class="search-results-grid">
              <!-- Video cards populated by JavaScript -->
            </div>
          </div>

          <!-- Search Loading State -->
          <div id="search-loading" class="search-loading hidden">
            <div class="processing-spinner"></div>
            <span id="search-loading-text">Searching for Arabic content...</span>
          </div>
        </div>
      </div>

      <!-- Parameters -->
      <div class="panel-section">
        <h3 class="section-title" id="params-heading">Parameters</h3>

        <!-- ILR Level -->
        <div class="field-group">
          <label for="ilr-slider" id="ilr-label">Target ILR Level</label>
          <input type="range" id="ilr-slider" class="form-range"
                 min="1" max="3.5" step="0.5" value="2"
                 aria-labelledby="ilr-label"
                 aria-valuemin="1" aria-valuemax="3.5" aria-valuenow="2"
                 aria-valuetext="ILR Level 2.0 - Limited Working Proficiency">
          <div class="ilr-display" aria-live="polite">
            <div class="ilr-badge-large" id="ilr-value">2.0</div>
            <div class="ilr-info">
              <h4 id="ilr-name">Limited Working Proficiency</h4>
              <p id="ilr-desc">Factual news, personal narratives, simple arguments</p>
            </div>
          </div>
        </div>

        <!-- Topic -->
        <fieldset class="field-group">
          <legend id="topic-label">Topic Category</legend>
          <div class="topic-grid" role="radiogroup" aria-labelledby="topic-label">
            <button class="topic-btn" data-topic="economy" role="radio" aria-checked="false" type="button">
              <span class="topic-icon" aria-hidden="true">&#128176;</span>
              <span class="topic-ar" lang="ar">الاقتصاد</span>
              <span class="topic-en">Economy</span>
            </button>
            <button class="topic-btn" data-topic="politics" role="radio" aria-checked="false" type="button">
              <span class="topic-icon" aria-hidden="true">&#127963;</span>
              <span class="topic-ar" lang="ar">السياسة</span>
              <span class="topic-en">Politics</span>
            </button>
            <button class="topic-btn" data-topic="culture" role="radio" aria-checked="false" type="button">
              <span class="topic-icon" aria-hidden="true">&#127912;</span>
              <span class="topic-ar" lang="ar">الثقافة</span>
              <span class="topic-en">Culture</span>
            </button>
            <button class="topic-btn" data-topic="science" role="radio" aria-checked="false" type="button">
              <span class="topic-icon" aria-hidden="true">&#128300;</span>
              <span class="topic-ar" lang="ar">العلوم</span>
              <span class="topic-en">Science</span>
            </button>
            <button class="topic-btn" data-topic="society" role="radio" aria-checked="false" type="button">
              <span class="topic-icon" aria-hidden="true">&#128101;</span>
              <span class="topic-ar" lang="ar">المجتمع</span>
              <span class="topic-en">Society</span>
            </button>
            <button class="topic-btn" data-topic="health" role="radio" aria-checked="false" type="button">
              <span class="topic-icon" aria-hidden="true">&#128138;</span>
              <span class="topic-ar" lang="ar">الصحة</span>
              <span class="topic-en">Health</span>
            </button>
            <button class="topic-btn active" data-topic="general" role="radio" aria-checked="true" type="button">
              <span class="topic-icon" aria-hidden="true">&#128218;</span>
              <span class="topic-ar" lang="ar">عام</span>
              <span class="topic-en">General</span>
            </button>
            <button class="topic-btn" data-topic="education" role="radio" aria-checked="false" type="button">
              <span class="topic-icon" aria-hidden="true">&#127891;</span>
              <span class="topic-ar" lang="ar">التعليم</span>
              <span class="topic-en">Education</span>
            </button>
          </div>
        </fieldset>
      </div>

      <!-- Generate Button -->
      <button class="btn btn-primary btn-lg" id="generate-btn" type="button" style="width: 100%;" aria-describedby="generate-hint">
        Generate Lesson
      </button>
      <p id="generate-hint" class="visually-hidden">Click to start generating an Arabic listening lesson based on your selected source and parameters</p>
    </aside>

    <!-- Main Content Area -->
    <section class="main-content" id="content-area" aria-label="Lesson generation workspace">
      <!-- Step Indicator -->
      <nav class="step-indicator" aria-label="Generation progress">
        <div class="step active" data-step="1" aria-current="step">
          <div class="step-number" aria-hidden="true">1</div>
          <span class="step-label">Input</span>
        </div>
        <div class="step-connector" aria-hidden="true"></div>
        <div class="step" data-step="2">
          <div class="step-number" aria-hidden="true">2</div>
          <span class="step-label">Process</span>
        </div>
        <div class="step-connector" aria-hidden="true"></div>
        <div class="step" data-step="3">
          <div class="step-number" aria-hidden="true">3</div>
          <span class="step-label">Review</span>
        </div>
        <div class="step-connector" aria-hidden="true"></div>
        <div class="step" data-step="4">
          <div class="step-number" aria-hidden="true">4</div>
          <span class="step-label">Export</span>
        </div>
      </nav>

      <!-- Content Card - Input State -->
      <div class="content-card" id="input-state">
        <div class="content-card-header">
          <h2 class="content-card-title">Create a New Lesson</h2>
        </div>

        <div style="text-align: center; padding: 60px 20px;">
          <div style="font-size: 64px; opacity: 0.3; margin-bottom: 24px;">&#127911;</div>
          <h3 style="margin-bottom: 12px;">Ready to Generate</h3>
          <p style="color: var(--color-text-secondary); max-width: 400px; margin: 0 auto;">
            Select a content source from the left panel, set your target ILR level and topic,
            then click "Generate Lesson" to begin.
          </p>
        </div>

        <!-- Video Preview (shown when YouTube URL entered) -->
        <div class="video-preview hidden" id="video-preview">
          <div class="video-thumbnail">
            <img id="video-thumb" src="" alt="Video thumbnail">
            <div class="video-play-overlay">
              <svg width="68" height="48" viewBox="0 0 68 48">
                <path fill="#f00" d="M66.52,7.74c-0.78-2.93-2.49-5.41-5.42-6.19C55.79,.13,34,0,34,0S12.21,.13,6.9,1.55 C3.97,2.33,2.27,4.81,1.48,7.74C0.06,13.05,0,24,0,24s0.06,10.95,1.48,16.26c0.78,2.93,2.49,5.41,5.42,6.19 C12.21,47.87,34,48,34,48s21.79-0.13,27.1-1.55c2.93-0.78,4.64-3.26,5.42-6.19C67.94,34.95,68,24,68,24S67.94,13.05,66.52,7.74z"/>
                <path fill="#fff" d="M 45,24 27,14 27,34"/>
              </svg>
            </div>
            <div class="video-duration-badge" id="video-duration-badge"></div>
          </div>
          <div class="video-info">
            <h3 id="video-title"></h3>
            <p id="video-channel" class="video-channel"></p>
            <div class="video-meta">
              <span id="video-duration"></span>
            </div>
            <div class="video-badges">
              <span class="badge" id="video-captions">Captions available</span>
              <span class="badge" id="video-language" style="display: none;"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Content Card - Processing State -->
      <div class="content-card hidden" id="processing-state" role="status" aria-live="polite" aria-atomic="true">
        <div class="processing-container">
          <div class="processing-spinner" aria-hidden="true"></div>
          <div class="processing-status" id="processing-status">Initializing...</div>
          <div class="processing-detail" id="processing-detail">Please wait</div>

          <div class="processing-progress">
            <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Generation progress">
              <div class="progress-bar-fill" id="progress-fill" style="width: 0%"></div>
            </div>
          </div>

          <div class="processing-steps" id="processing-steps">
            <div class="processing-step" data-step="fetch">
              <div class="processing-step-icon">&#128250;</div>
              <div class="processing-step-text">
                <div class="processing-step-name">Fetch Content</div>
                <div class="processing-step-status">Waiting...</div>
              </div>
            </div>
            <div class="processing-step" data-step="transcribe">
              <div class="processing-step-icon">&#128221;</div>
              <div class="processing-step-text">
                <div class="processing-step-name">Transcribe Audio</div>
                <div class="processing-step-status">Waiting...</div>
              </div>
            </div>
            <div class="processing-step" data-step="analyze">
              <div class="processing-step-icon">&#128200;</div>
              <div class="processing-step-text">
                <div class="processing-step-name">Analyze Content</div>
                <div class="processing-step-status">Waiting...</div>
              </div>
            </div>
            <div class="processing-step" data-step="questions">
              <div class="processing-step-icon">&#10067;</div>
              <div class="processing-step-text">
                <div class="processing-step-name">Generate Questions</div>
                <div class="processing-step-status">Waiting...</div>
              </div>
            </div>
            <div class="processing-step" data-step="assemble">
              <div class="processing-step-icon">&#128230;</div>
              <div class="processing-step-text">
                <div class="processing-step-name">Assemble Lesson</div>
                <div class="processing-step-status">Waiting...</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Content Card - Review State -->
      <div class="content-card hidden" id="review-state">
        <div class="content-card-header">
          <h2 class="content-card-title">Review Lesson</h2>
          <div>
            <button class="btn btn-secondary btn-sm" id="edit-transcript-btn">Edit Transcript</button>
          </div>
        </div>

        <!-- Analysis Summary -->
        <div class="analysis-grid">
          <div class="analysis-card">
            <div class="analysis-label">ILR Level</div>
            <div class="analysis-value" id="result-ilr">2.0</div>
            <div class="analysis-detail" id="result-ilr-name">Limited Working</div>
          </div>
          <div class="analysis-card">
            <div class="analysis-label">Duration</div>
            <div class="analysis-value" id="result-duration">3:45</div>
            <div class="analysis-detail">minutes</div>
          </div>
          <div class="analysis-card">
            <div class="analysis-label">Words</div>
            <div class="analysis-value" id="result-words">342</div>
            <div class="analysis-detail" id="result-unique">187 unique</div>
          </div>
          <div class="analysis-card">
            <div class="analysis-label">Dialect</div>
            <div class="analysis-value" id="result-dialect">MSA</div>
            <div class="analysis-detail">Modern Standard</div>
          </div>
        </div>

        <!-- Transcript Editor with Confidence -->
        <div class="transcript-editor">
          <div class="transcript-editor-header">
            <span class="transcript-editor-title">Transcript (click to edit)</span>
            <div class="confidence-legend">
              <div class="confidence-legend-item">
                <span class="confidence-dot high"></span>
                <span>High confidence</span>
              </div>
              <div class="confidence-legend-item">
                <span class="confidence-dot medium"></span>
                <span>Review suggested</span>
              </div>
              <div class="confidence-legend-item">
                <span class="confidence-dot low"></span>
                <span>Needs correction</span>
              </div>
            </div>
          </div>
          <div class="editable-transcript" id="transcript-preview">
            <!-- Populated by JavaScript with confidence-colored segments -->
          </div>
          <div class="transcript-save-status" id="transcript-save-status">
            <span>Changes auto-saved</span>
          </div>
        </div>

        <!-- Questions Preview -->
        <div style="margin-top: 24px;">
          <h3 style="margin-bottom: 12px;">Generated Questions</h3>

          <div class="questions-section">
            <h4>
              <span>Pre-Listening</span>
              <span class="question-count" id="pre-count">2</span>
            </h4>
            <div id="pre-questions">
              <!-- Populated by JavaScript -->
            </div>
          </div>

          <div class="questions-section">
            <h4>
              <span>While-Listening</span>
              <span class="question-count" id="while-count">8</span>
            </h4>
            <div id="while-questions">
              <!-- Populated by JavaScript -->
            </div>
          </div>

          <div class="questions-section">
            <h4>
              <span>Post-Listening</span>
              <span class="question-count" id="post-count">4</span>
            </h4>
            <div id="post-questions">
              <!-- Populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>

      <!-- Action Bar -->
      <div class="action-bar" id="action-bar" role="toolbar" aria-label="Lesson actions">
        <div class="action-group">
          <button class="btn btn-ghost" id="back-btn" type="button" disabled aria-disabled="true">Back</button>
        </div>
        <div class="action-group">
          <button class="btn btn-secondary" id="preview-btn" type="button" disabled aria-disabled="true">Preview</button>
          <button class="btn btn-primary" id="export-btn" type="button" disabled aria-disabled="true">Export Lesson</button>
        </div>
      </div>
    </section>

    <!-- Right Panel: Status & Help -->
    <aside class="panel panel-right" id="status-panel" aria-label="Status and help">
      <div class="panel-section">
        <h3 class="section-title" id="quota-heading">LLM Quota</h3>

        <div class="status-card">
          <div class="status-header">
            <div class="status-indicator"></div>
            <span class="status-title">Google AI Studio</span>
          </div>
          <div class="quota-bar">
            <div class="quota-fill" style="width: 100%"></div>
          </div>
          <div class="quota-text">250 / 250 requests remaining today</div>
        </div>

        <div class="status-card">
          <div class="status-header">
            <div class="status-indicator"></div>
            <span class="status-title">Groq</span>
          </div>
          <div class="quota-bar">
            <div class="quota-fill" style="width: 100%"></div>
          </div>
          <div class="quota-text">1,000 / 1,000 requests remaining</div>
        </div>

        <div class="status-card">
          <div class="status-header">
            <div class="status-indicator"></div>
            <span class="status-title">OpenRouter</span>
          </div>
          <div class="quota-bar">
            <div class="quota-fill" style="width: 100%"></div>
          </div>
          <div class="quota-text">50 / 50 requests remaining</div>
        </div>
      </div>

      <div class="panel-section">
        <h3 class="section-title">Tips</h3>

        <div class="tips-card">
          <div class="tips-title">Getting the Best Results</div>
          <ul class="tips-list">
            <li>Choose videos with clear audio and minimal background noise</li>
            <li>YouTube videos with existing captions work best</li>
            <li>Keep duration under 5 minutes for faster processing</li>
            <li>Select the appropriate ILR level for your students</li>
          </ul>
        </div>
      </div>

      <div class="panel-section">
        <h3 class="section-title">About ILR Levels</h3>

        <div class="status-card">
          <p style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-bottom: 12px;">
            The Interagency Language Roundtable (ILR) scale is the standard grading scale for
            language proficiency in the US government.
          </p>
          <a href="about.html#ilr" class="btn btn-ghost btn-sm" style="width: 100%;">
            Learn More
          </a>
        </div>
      </div>
    </aside>
  </main>

  <!-- Mobile Toolbar -->
  <nav class="mobile-toolbar" role="tablist" aria-label="Mobile panel navigation">
    <button class="mobile-toolbar-btn active" data-panel="config" role="tab" aria-selected="true" type="button">
      <span style="font-size: 20px;" aria-hidden="true">&#9881;</span>
      <span>Config</span>
    </button>
    <button class="mobile-toolbar-btn" data-panel="main" role="tab" aria-selected="false" type="button">
      <span style="font-size: 20px;" aria-hidden="true">&#128221;</span>
      <span>Content</span>
    </button>
    <button class="mobile-toolbar-btn" data-panel="status" role="tab" aria-selected="false" type="button">
      <span style="font-size: 20px;" aria-hidden="true">&#128200;</span>
      <span>Status</span>
    </button>
  </nav>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container" role="status" aria-live="polite" aria-atomic="true"></div>

  <!-- Scripts -->
  <script type="module">
    import { EventBus, Events } from './js/core/event-bus.js';
    import { StateManager } from './js/core/state-manager.js';
    import { Config } from './js/core/config.js';
    import { extractYouTubeId, formatTime, $ } from './js/core/utils.js';
    import { lessonGeneratorWorkflow } from './js/workflows/lesson-generator-workflow.js';

    // Error handling for module imports
    window.addEventListener('error', (e) => {
      if (e.message && e.message.includes('import')) {
        console.error('Module loading error:', e.message);
        const container = document.getElementById('toast-container');
        if (container) {
          const toast = document.createElement('div');
          toast.className = 'toast toast-error';
          toast.innerHTML = '<div class="toast-content"><div class="toast-title">Loading Error</div><div class="toast-message">Failed to load application modules. Please refresh the page.</div></div>';
          container.appendChild(toast);
        }
      }
    });

    // ILR Level data
    const ILR_DATA = {
      '1': { name: 'Elementary', desc: 'Short, simple texts with familiar vocabulary' },
      '1.5': { name: 'Elementary+', desc: 'Simple conversations on routine topics' },
      '2': { name: 'Limited Working', desc: 'Factual news, personal narratives, simple arguments' },
      '2.5': { name: 'Limited Working+', desc: 'Standard news, formal speeches, extended arguments' },
      '3': { name: 'General Professional', desc: 'Political analysis, technical discussions' },
      '3.5': { name: 'General Professional+', desc: 'Complex argumentation, nuanced content' }
    };

    // DOM elements
    const sourceTabs = document.querySelectorAll('.source-tab');
    const sourceContents = document.querySelectorAll('.source-content');
    const topicBtns = document.querySelectorAll('.topic-btn');
    const ilrSlider = $('#ilr-slider');
    const generateBtn = $('#generate-btn');
    const youtubeInput = $('#youtube-url');
    const dropZone = $('#drop-zone');
    const fileInput = $('#file-input');

    // Source tab switching
    sourceTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        sourceTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        const source = tab.dataset.source;
        sourceContents.forEach(content => {
          content.classList.toggle('hidden', !content.id.includes(source));
        });

        StateManager.set('source.type', source);
      });
    });

    // Topic selection
    topicBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        topicBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        StateManager.set('params.topic', btn.dataset.topic);
      });
    });

    // ILR slider
    ilrSlider.addEventListener('input', () => {
      const value = ilrSlider.value;
      const data = ILR_DATA[value];
      $('#ilr-value').textContent = parseFloat(value).toFixed(1);
      $('#ilr-name').textContent = data.name;
      $('#ilr-desc').textContent = data.desc;
      StateManager.set('params.targetIlr', parseFloat(value));
    });

    // File upload
    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      if (e.dataTransfer.files.length) {
        handleFile(e.dataTransfer.files[0]);
      }
    });

    fileInput.addEventListener('change', () => {
      if (fileInput.files.length) {
        handleFile(fileInput.files[0]);
      }
    });

    function handleFile(file) {
      // Validate file type
      const validTypes = ['audio/mp3', 'audio/mpeg', 'audio/wav', 'audio/m4a', 'audio/ogg', 'audio/webm'];
      if (!validTypes.includes(file.type) && !file.name.match(/\.(mp3|wav|m4a|ogg|webm|aac)$/i)) {
        showToast('error', 'Invalid file type', 'Please upload an audio file');
        return;
      }

      // Check file size (100MB max)
      if (file.size > 100 * 1024 * 1024) {
        showToast('error', 'File too large', 'Maximum file size is 100MB');
        return;
      }

      // Show preview
      $('#file-name').textContent = file.name;
      $('#file-size').textContent = formatBytes(file.size);
      $('#file-preview').classList.remove('hidden');
      dropZone.classList.add('hidden');

      StateManager.set('source.file', file);
    }

    function formatBytes(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    $('#file-remove')?.addEventListener('click', () => {
      StateManager.set('source.file', null);
      fileInput.value = '';
      $('#file-preview').classList.add('hidden');
      dropZone.classList.remove('hidden');
    });

    // YouTube URL validation and preview
    let currentVideoId = null;

    youtubeInput.addEventListener('input', debounce(async () => {
      const url = youtubeInput.value.trim();
      const videoId = extractYouTubeId(url);

      // Hide preview if URL cleared or invalid
      if (!videoId) {
        hideVideoPreview();
        currentVideoId = null;
        return;
      }

      // Skip if same video
      if (videoId === currentVideoId) return;
      currentVideoId = videoId;

      // Show loading state
      showVideoLoading();

      try {
        // Fetch video metadata from worker
        const response = await fetch(`${Config.WORKER_URL}/api/youtube/metadata?v=${videoId}`);
        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        // Update state
        StateManager.set('source', {
          type: 'youtube',
          url: url,
          videoId: videoId,
          metadata: data
        });

        // Display video preview
        showVideoPreview(data);

        showToast('success', 'Video found', data.captions?.available ? 'Captions available' : 'Will need transcription');

      } catch (error) {
        console.error('Failed to fetch video:', error);
        hideVideoPreview();
        showToast('error', 'Video not found', error.message || 'Could not load video metadata');
        currentVideoId = null;
      }
    }, 500));

    function showVideoLoading() {
      const preview = $('#video-preview');
      const placeholder = preview.previousElementSibling;

      placeholder.classList.add('hidden');
      preview.classList.remove('hidden');

      $('#video-thumb').src = '';
      $('#video-thumb').alt = 'Loading...';
      $('#video-title').textContent = 'Loading video...';
      $('#video-channel').textContent = '';
      $('#video-duration').textContent = '';
      $('#video-captions').textContent = 'Checking captions...';
      $('#video-captions').className = 'badge';
    }

    function showVideoPreview(data) {
      const preview = $('#video-preview');
      const placeholder = preview.previousElementSibling;

      placeholder.classList.add('hidden');
      preview.classList.remove('hidden');

      // Set thumbnail
      $('#video-thumb').src = data.thumbnail || `https://i.ytimg.com/vi/${data.videoId}/hqdefault.jpg`;
      $('#video-thumb').alt = data.title;

      // Set title and channel
      $('#video-title').textContent = data.title || 'Untitled Video';
      $('#video-channel').textContent = data.author || 'Unknown Channel';

      // Set duration
      if (data.duration) {
        const mins = Math.floor(data.duration / 60);
        const secs = data.duration % 60;
        $('#video-duration').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

        // Warning if too long
        if (data.duration > 600) {
          showToast('warning', 'Long video', 'Videos over 10 minutes may take a while to process');
        }
      } else {
        $('#video-duration').textContent = '';
      }

      // Set captions badge
      const captionsBadge = $('#video-captions');
      if (data.captions?.available) {
        captionsBadge.textContent = 'Captions available';
        captionsBadge.className = 'badge badge-success';
      } else {
        captionsBadge.textContent = 'No captions - will transcribe';
        captionsBadge.className = 'badge badge-warning';
      }
    }

    function hideVideoPreview() {
      const preview = $('#video-preview');
      const placeholder = preview.previousElementSibling;

      preview.classList.add('hidden');
      placeholder.classList.remove('hidden');
    }

    function debounce(fn, ms) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn(...args), ms);
      };
    }

    // Generate button
    generateBtn.addEventListener('click', async () => {
      const sourceType = StateManager.get('source.type');

      if (sourceType === 'youtube' && !youtubeInput.value.trim()) {
        showToast('error', 'Missing URL', 'Please enter a YouTube URL');
        return;
      }

      if (sourceType === 'search') {
        // Check if a video was selected from search
        const source = StateManager.get('source');
        if (!source?.videoId) {
          showToast('error', 'No video selected', 'Please search and select a video');
          return;
        }
      }

      if (sourceType === 'upload' && !StateManager.get('source.file')) {
        showToast('error', 'No file', 'Please upload an audio file');
        return;
      }

      // Start processing
      showProcessingState();
    });

    function showProcessingState() {
      $('#input-state').classList.add('hidden');
      $('#processing-state').classList.remove('hidden');

      // Update step indicator
      document.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active', 'completed');
      });
      document.querySelector('[data-step="1"]').classList.add('completed');
      document.querySelector('[data-step="2"]').classList.add('active');

      // Simulate processing (in production, this would be real)
      simulateProcessing();
    }

    async function simulateProcessing() {
      const steps = ['fetch', 'transcribe', 'analyze', 'questions', 'assemble'];
      const stepMessages = {
        fetch: { status: 'Fetching content...', detail: 'Connecting to source' },
        transcribe: { status: 'Transcribing audio...', detail: 'Using Whisper model' },
        analyze: { status: 'Analyzing content...', detail: 'Calculating ILR level' },
        questions: { status: 'Generating questions...', detail: 'Creating comprehension exercises' },
        assemble: { status: 'Assembling lesson...', detail: 'Preparing final output' }
      };

      // Get source and parameters from state
      const source = StateManager.get('source');
      const targetIlr = StateManager.get('params.targetIlr') || 2.0;
      const topic = StateManager.get('params.topic') || 'general';

      try {
        // Start the real workflow
        await lessonGeneratorWorkflow.generate({
          source,
          targetIlr,
          topic,
          onProgress: (progress) => {
            const { step, percent, message, stage } = progress;

            // Update current step status
            const stepEl = document.querySelector(`[data-step="${step}"]`);
            if (stepEl) {
              // Mark previous steps as completed
              const currentIndex = steps.indexOf(step);
              steps.slice(0, currentIndex).forEach(s => {
                const el = document.querySelector(`[data-step="${s}"]`);
                if (el) {
                  el.classList.remove('active');
                  el.classList.add('completed');
                  el.querySelector('.processing-step-status').textContent = 'Complete';
                }
              });

              // Mark current step as active
              stepEl.classList.add('active');
              stepEl.classList.remove('completed');
              stepEl.querySelector('.processing-step-status').textContent = 'In progress...';
            }

            // Update main status text
            const msg = stepMessages[step];
            if (msg) {
              $('#processing-status').textContent = msg.status;
              $('#processing-detail').textContent = message || stage || msg.detail;
            }

            // Update progress bar
            $('#progress-fill').style.width = `${percent}%`;

            // Show streaming transcript if available
            if (step === 'transcribe' && progress.currentText) {
              // Could show streaming text here if UI supports it
              console.log('Transcription progress:', progress.currentText);
            }
          }
        });

        // Mark all steps complete
        steps.forEach(s => {
          const el = document.querySelector(`[data-step="${s}"]`);
          if (el) {
            el.classList.remove('active');
            el.classList.add('completed');
            el.querySelector('.processing-step-status').textContent = 'Complete';
          }
        });

        // Show review state with real data
        showReviewStateWithLesson();

      } catch (error) {
        console.error('Lesson generation failed:', error);
        showToast('error', 'Generation Failed', error.message);

        // Show error state
        $('#processing-state').classList.add('hidden');
        $('#input-state').classList.remove('hidden');
      }
    }

    function showReviewStateWithLesson() {
      $('#processing-state').classList.add('hidden');
      $('#review-state').classList.remove('hidden');

      // Update step indicator
      document.querySelector('[data-step="2"]').classList.remove('active');
      document.querySelector('[data-step="2"]').classList.add('completed');
      document.querySelector('[data-step="3"]').classList.add('active');

      // Enable buttons
      $('#back-btn').disabled = false;
      $('#preview-btn').disabled = false;
      $('#export-btn').disabled = false;

      // Populate with real lesson data
      const lesson = StateManager.get('lesson');
      if (lesson) {
        populateLessonData(lesson);
      } else {
        // Fallback to sample data if something went wrong
        populateSampleData();
      }
    }

    function getConfidenceClass(confidence) {
      // Map confidence score to CSS class
      if (confidence >= 0.85) return 'confidence-high';
      if (confidence >= 0.6) return 'confidence-medium';
      return 'confidence-low';
    }

    function populateLessonData(lesson) {
      // Populate transcript with confidence-based coloring
      const transcriptHtml = lesson.content.transcript.segments.map((seg, idx) => {
        const confidence = seg.confidence || 0.8;
        const confidenceClass = getConfidenceClass(confidence);
        const confidencePercent = Math.round(confidence * 100);

        return `
          <div class="transcript-segment ${confidenceClass}"
               data-index="${idx}"
               data-start="${seg.start}"
               data-end="${seg.end || seg.start + 5}"
               data-confidence="${confidence}"
               title="Confidence: ${confidencePercent}%">
            <span class="segment-time">${formatTime(seg.start)}</span>
            <span class="segment-text" contenteditable="true" dir="rtl" lang="ar">${seg.text}</span>
          </div>
        `;
      }).join('');

      $('#transcript-preview').innerHTML = transcriptHtml;

      // Add edit handlers for transcript segments
      setupTranscriptEditing(lesson);

      // Populate questions
      ['pre', 'while', 'post'].forEach(phase => {
        const questions = lesson.content.questions[phase];
        const container = $(`#${phase}-questions`);
        const countEl = $(`#${phase}-count`);

        countEl.textContent = questions.length;

        container.innerHTML = questions.map((q, i) => `
          <div class="question-item">
            <div class="question-number">${i + 1}</div>
            <div class="question-content">
              <div class="question-text">
                <div class="question-text-ar">${q.question_text.ar}</div>
                <div class="question-text-en">${q.question_text.en}</div>
              </div>
              <span class="question-type">${q.type.replace(/_/g, ' ')}</span>
            </div>
          </div>
        `).join('');
      });

      // Show success message
      showToast('success', 'Lesson Generated!', 'Your lesson is ready to preview');
    }

    function setupTranscriptEditing(lesson) {
      const statusEl = $('#transcript-save-status');
      let saveTimeout = null;

      // Handle edits to transcript segments
      $('#transcript-preview').addEventListener('input', (e) => {
        if (e.target.classList.contains('segment-text')) {
          const segment = e.target.closest('.transcript-segment');
          const index = parseInt(segment.dataset.index, 10);
          const newText = e.target.textContent.trim();

          // Update the lesson data
          if (lesson.content.transcript.segments[index]) {
            lesson.content.transcript.segments[index].text = newText;

            // Mark as user-corrected (high confidence now)
            lesson.content.transcript.segments[index].confidence = 1.0;
            lesson.content.transcript.segments[index].userCorrected = true;

            // Update visual styling to high confidence
            segment.classList.remove('confidence-low', 'confidence-medium');
            segment.classList.add('confidence-high');
            segment.dataset.confidence = '1.0';
            segment.title = 'Confidence: 100% (corrected)';
          }

          // Update state
          StateManager.set('lesson', lesson);

          // Show saving status
          statusEl.innerHTML = '<span class="saving">Saving...</span>';

          // Debounce the "saved" status
          clearTimeout(saveTimeout);
          saveTimeout = setTimeout(() => {
            statusEl.innerHTML = '<span class="saved">✓ Changes saved</span>';
          }, 500);
        }
      });

      // Handle focus for accessibility
      $('#transcript-preview').addEventListener('focus', (e) => {
        if (e.target.classList.contains('segment-text')) {
          e.target.closest('.transcript-segment').classList.add('editing');
        }
      }, true);

      $('#transcript-preview').addEventListener('blur', (e) => {
        if (e.target.classList.contains('segment-text')) {
          e.target.closest('.transcript-segment').classList.remove('editing');
        }
      }, true);
    }

    // showReviewState removed - now using showReviewStateWithLesson from simulateProcessing

    function populateSampleData() {
      // Sample transcript with varied confidence levels to demonstrate the feature
      const sampleTranscript = [
        { start: 0, text: 'شهد الاقتصاد العربي نمواً ملحوظاً في السنوات الأخيرة', confidence: 0.95 },
        { start: 8, text: 'وقد ساهمت عدة عوامل في هذا النمو الاقتصادي', confidence: 0.72 },
        { start: 15, text: 'من أهمها ارتفاع أسعار النفط والاستثمارات الأجنبية', confidence: 0.45 },
        { start: 23, text: 'كما لعبت الإصلاحات الاقتصادية دوراً مهماً في تعزيز النمو', confidence: 0.88 }
      ];

      const transcriptHtml = sampleTranscript.map((seg, idx) => {
        const confidenceClass = getConfidenceClass(seg.confidence);
        const confidencePercent = Math.round(seg.confidence * 100);

        return `
          <div class="transcript-segment ${confidenceClass}"
               data-index="${idx}"
               data-start="${seg.start}"
               data-confidence="${seg.confidence}"
               title="Confidence: ${confidencePercent}%">
            <span class="segment-time">${formatTime(seg.start)}</span>
            <span class="segment-text" contenteditable="true" dir="rtl" lang="ar">${seg.text}</span>
          </div>
        `;
      }).join('');

      $('#transcript-preview').innerHTML = transcriptHtml;

      // Sample questions
      const sampleQuestions = {
        pre: [
          { ar: 'ماذا تتوقع أن يناقش هذا التسجيل؟', en: 'What do you expect this recording to discuss?', type: 'multiple_choice' },
          { ar: 'ما هي معلوماتك السابقة عن الاقتصاد العربي؟', en: 'What do you already know about the Arab economy?', type: 'open_ended' }
        ],
        while: [
          { ar: 'ما الفكرة الرئيسية لهذا التسجيل؟', en: 'What is the main idea of this recording?', type: 'multiple_choice' },
          { ar: 'ذكر المتحدث عدة عوامل. صح أم خطأ؟', en: 'The speaker mentioned several factors. True or false?', type: 'true_false' }
        ],
        post: [
          { ar: 'ما موقف المتحدث من الموضوع؟', en: "What is the speaker's attitude toward the topic?", type: 'multiple_choice' },
          { ar: 'لخص الفكرة الرئيسية في جملة واحدة', en: 'Summarize the main idea in one sentence', type: 'open_ended' }
        ]
      };

      Object.entries(sampleQuestions).forEach(([phase, questions]) => {
        const container = $(`#${phase}-questions`);
        const countEl = $(`#${phase}-count`);
        countEl.textContent = questions.length;

        container.innerHTML = questions.map((q, i) => `
          <div class="question-item">
            <div class="question-number">${i + 1}</div>
            <div class="question-content">
              <div class="question-text">
                <div class="question-text-ar">${q.ar}</div>
                <div class="question-text-en">${q.en}</div>
              </div>
              <span class="question-type">${q.type.replace('_', ' ')}</span>
            </div>
          </div>
        `).join('');
      });
    }

    // Preview button - open lesson in player
    $('#preview-btn').addEventListener('click', () => {
      // Use the generated lesson from state
      const lesson = StateManager.get('lesson');
      if (!lesson) {
        showToast('error', 'No lesson', 'Please generate a lesson first');
        return;
      }

      // Save to localStorage for player to load
      localStorage.setItem('tanaghum_current_lesson', JSON.stringify(lesson));
      window.location.href = 'player.html';
    });

    // Export button - show export options
    let exportDialog = null;

    $('#export-btn').addEventListener('click', async () => {
      const lesson = StateManager.get('lesson');
      if (!lesson) {
        showToast('error', 'No lesson', 'Please generate a lesson first');
        return;
      }

      // Dynamically load export dialog
      if (!exportDialog) {
        try {
          const module = await import('./js/ui/export-dialog.js');
          exportDialog = module.exportDialog || new module.ExportDialog();
        } catch (error) {
          // Fallback to JSON export if export dialog fails to load
          console.error('Export dialog failed to load, using JSON fallback:', error);
          exportAsJson(lesson);
          return;
        }
      }

      exportDialog.show(lesson);
    });

    // Fallback JSON export function
    function exportAsJson(lesson) {
      const json = JSON.stringify(lesson, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      const timestamp = new Date().toISOString().split('T')[0];
      const title = (lesson.metadata?.title?.en || 'lesson').substring(0, 30).replace(/[^a-zA-Z0-9]/g, '-');
      a.download = `tanaghum-${title}-${timestamp}.json`;
      a.click();

      URL.revokeObjectURL(url);
      showToast('success', 'Exported', 'Lesson JSON downloaded');
    }

    // Create a lesson object for preview/export
    // createPreviewLesson removed - now using real lesson data from workflow

    // Toast notifications
    function showToast(type, title, message) {
      const container = $('#toast-container');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close">&times;</button>
      `;

      container.appendChild(toast);

      toast.querySelector('.toast-close').addEventListener('click', () => {
        toast.remove();
      });

      setTimeout(() => toast.remove(), 4000);
    }

    // Smart Search functionality
    const searchQuery = $('#search-query');
    const searchBtn = $('#search-btn');
    const searchResults = $('#search-results');
    const searchResultsGrid = $('#search-results-grid');
    const searchResultsCount = $('#search-results-count');
    const searchLoading = $('#search-loading');
    const searchLoadingText = $('#search-loading-text');
    const clearSearchBtn = $('#clear-search');
    const aiSuggestBtn = $('#ai-suggest-btn');
    const suggestedQueries = $('#suggested-queries');

    // Import LLM client for AI evaluation
    let llmClient = null;

    async function loadLLMClient() {
      if (!llmClient) {
        const module = await import('./js/generation/llm-client.js');
        llmClient = module.llmClient;
      }
      return llmClient;
    }

    async function performSearch() {
      const query = searchQuery.value.trim();
      if (!query) {
        showToast('error', 'Empty search', 'Please enter a search term');
        return;
      }

      // Show loading state
      searchLoading.classList.remove('hidden');
      searchLoadingText.textContent = 'Searching YouTube...';
      searchResults.classList.add('hidden');
      searchBtn.disabled = true;

      try {
        // Step 1: Get raw search results
        const response = await fetch(`${Config.WORKER_URL}/api/youtube/search?q=${encodeURIComponent(query)}`);
        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        const rawVideos = data.videos || [];

        if (rawVideos.length === 0) {
          displaySearchResults([]);
          return;
        }

        // Step 2: Evaluate with AI
        searchLoadingText.textContent = 'AI evaluating content quality...';

        const client = await loadLLMClient();
        const targetIlr = parseFloat(ilrSlider.value);
        const topic = document.querySelector('.topic-btn.active')?.dataset.topic || 'general';

        const evaluatedVideos = await client.evaluateSearchResults(rawVideos, {
          targetIlr,
          topic,
          maxResults: 8
        });

        // Display evaluated results
        displaySearchResults(evaluatedVideos, true);
        showToast('success', 'AI Search complete', `Found ${evaluatedVideos.length} suitable videos`);

      } catch (error) {
        console.error('Search failed:', error);
        showToast('error', 'Search failed', error.message || 'Could not search YouTube');
      } finally {
        searchLoading.classList.add('hidden');
        searchBtn.disabled = false;
      }
    }

    function displaySearchResults(videos, hasEvaluation = false) {
      if (videos.length === 0) {
        searchResultsCount.textContent = 'No videos found';
        searchResultsGrid.innerHTML = '<p style="text-align: center; color: var(--color-text-muted); padding: 20px;">Try a different search term</p>';
        searchResults.classList.remove('hidden');
        return;
      }

      searchResultsCount.textContent = hasEvaluation
        ? `${videos.length} AI-curated videos`
        : `${videos.length} videos found`;

      searchResultsGrid.innerHTML = videos.map(video => {
        const evalBadge = video.evaluation
          ? `<div class="eval-badge" title="${video.evaluation.reason || ''}">
               <span class="eval-score">${video.evaluation.score}/10</span>
               <span class="eval-ilr">ILR ~${video.evaluation.estimatedIlr}</span>
             </div>`
          : '';

        return `
          <div class="video-search-card${video.evaluation?.score >= 8 ? ' recommended' : ''}" data-video-id="${video.videoId}" data-video='${JSON.stringify(video).replace(/'/g, "&#39;")}'>
            <img class="video-thumb-small" src="${video.thumbnail}" alt="${video.title}" loading="lazy">
            <div class="video-info">
              <h4>${video.title}</h4>
              <div class="video-channel">${video.channel}</div>
              <div class="video-meta-row">
                <span>${video.duration || ''}</span>
                ${evalBadge}
              </div>
            </div>
          </div>
        `;
      }).join('');

      searchResults.classList.remove('hidden');

      // Add click handlers to select videos
      searchResultsGrid.querySelectorAll('.video-search-card').forEach(card => {
        card.addEventListener('click', () => selectSearchResult(card));
      });
    }

    // AI Suggest queries
    aiSuggestBtn?.addEventListener('click', async () => {
      aiSuggestBtn.disabled = true;
      aiSuggestBtn.innerHTML = '<span class="processing-spinner" style="width:16px;height:16px;border-width:2px;margin-right:8px;"></span> Generating...';

      try {
        const client = await loadLLMClient();
        const targetIlr = parseFloat(ilrSlider.value);
        const topic = document.querySelector('.topic-btn.active')?.dataset.topic || 'general';

        const suggestions = await client.generateSearchQueries({
          targetIlr,
          topic,
          count: 4
        });

        if (suggestions.length > 0) {
          displaySuggestedQueries(suggestions);
        } else {
          showToast('warning', 'No suggestions', 'Could not generate suggestions');
        }
      } catch (error) {
        console.error('AI suggest failed:', error);
        showToast('error', 'AI suggest failed', error.message);
      } finally {
        aiSuggestBtn.disabled = false;
        aiSuggestBtn.innerHTML = '<span>&#10024;</span> AI Suggest Queries for My Level';
      }
    });

    function displaySuggestedQueries(suggestions) {
      suggestedQueries.innerHTML = suggestions.map(s => `
        <button class="suggested-query-btn" data-query="${s.query}">
          <span class="query-text">${s.query}</span>
          <span class="query-desc">${s.description || ''}</span>
        </button>
      `).join('');

      suggestedQueries.classList.remove('hidden');

      // Add click handlers
      suggestedQueries.querySelectorAll('.suggested-query-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          searchQuery.value = btn.dataset.query;
          performSearch();
        });
      });
    }

    async function selectSearchResult(card) {
      const videoId = card.dataset.videoId;
      const videoData = JSON.parse(card.dataset.video);

      // Mark as selected
      searchResultsGrid.querySelectorAll('.video-search-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');

      // Update state
      StateManager.set('source', {
        type: 'youtube',
        url: `https://www.youtube.com/watch?v=${videoId}`,
        videoId: videoId,
        metadata: {
          title: videoData.title,
          author: videoData.channel,
          thumbnail: videoData.thumbnail,
          duration: videoData.durationSeconds,
          captions: { available: false } // Will check when processing
        }
      });

      // Show preview in main content area
      showVideoPreview({
        videoId: videoId,
        title: videoData.title,
        author: videoData.channel,
        thumbnail: videoData.thumbnail,
        duration: videoData.durationSeconds,
        captions: { available: false }
      });

      showToast('success', 'Video selected', 'Ready to generate lesson');
    }

    // Search on button click
    searchBtn?.addEventListener('click', performSearch);

    // Search on Enter key
    searchQuery?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        performSearch();
      }
    });

    // Clear search results
    clearSearchBtn?.addEventListener('click', () => {
      searchQuery.value = '';
      searchResults.classList.add('hidden');
      searchResultsGrid.innerHTML = '';
    });

    // Mobile panel switching
    document.querySelectorAll('.mobile-toolbar-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.mobile-toolbar-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // Handle panel switching for mobile
        const panel = btn.dataset.panel;
        if (panel === 'config') {
          $('#config-panel').classList.add('mobile-open');
        } else {
          $('#config-panel').classList.remove('mobile-open');
        }
      });
    });

    // Listen for model loading events
    EventBus.on(Events.MODEL_LOADING, (data) => {
      if (data.model === 'whisper') {
        const message = data.file ? `Loading: ${data.file}` : 'Loading Whisper model...';
        const percent = data.progress || 0;
        console.log(`Whisper model loading: ${percent}% - ${message}`);
      }
    });

    EventBus.on(Events.MODEL_READY, (data) => {
      if (data.model === 'whisper') {
        console.log('Whisper model ready');
      }
    });

    EventBus.on(Events.MODEL_ERROR, (data) => {
      if (data.model === 'whisper') {
        console.error('Whisper model error:', data.error);
        showToast('error', 'Model Error', data.error);
      }
    });

    // Listen for transcription events
    EventBus.on(Events.TRANSCRIPTION_PROGRESS, (data) => {
      console.log(`Transcription: ${data.progress}%`);
    });

    // Initialize
    StateManager.set('source.type', 'youtube');
    console.log('Tanaghum Generator initialized');
  </script>
</body>
</html>
