<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Generate Arabic comprehension lessons with synchronized audio and text">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://tanaghum.app/generator.html">

  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="Generate Lesson | Tanaghum">
  <meta property="og:description" content="Generate Arabic comprehension lessons with synchronized audio and text">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://tanaghum.app/generator.html">
  <meta property="og:site_name" content="Tanaghum">

  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Generate Lesson | Tanaghum">
  <meta name="twitter:description" content="Generate Arabic comprehension lessons with synchronized audio and text">

  <title>Generate Lesson | Tanaghum</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Naskh+Arabic:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/generator.css">
  <link rel="stylesheet" href="css/export-dialog.css">
</head>
<body>
  <!-- Skip Navigation Link -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Header -->
  <header class="header" role="banner">
    <div class="header-inner">
      <a href="index.html" class="logo">
        <h1 class="sr-only">Tanaghum - Generate Arabic Lesson</h1>
        <span class="logo-arabic" lang="ar" aria-hidden="true">ÿ™ŸÜÿßÿ∫ŸÖ</span>
        <span aria-hidden="true">Tanaghum</span>
      </a>
      <nav class="nav" aria-label="Main navigation">
        <a href="index.html" class="nav-link">Home</a>
        <a href="generator.html" class="nav-link active" aria-current="page">Generate</a>
        <a href="gallery.html" class="nav-link">Gallery</a>
        <a href="about.html" class="nav-link">About</a>
      </nav>
      <div class="auth-section" id="auth-section" data-state="loading">
        <div id="google-signin-btn" class="google-signin-container"></div>
        <div class="user-menu">
          <img class="user-avatar" src="" alt="User avatar" width="32" height="32">
          <span class="user-name"></span>
          <div class="user-dropdown">
            <div class="user-dropdown-email"></div>
            <button class="user-dropdown-item" id="auth-settings-btn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
              API Keys
            </button>
            <div class="user-dropdown-divider"></div>
            <button class="user-dropdown-item" id="auth-logout-btn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
              Sign out
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Three-Panel Layout -->
  <main class="generator-layout" id="main-content" tabindex="-1">
    <!-- Left Panel: Configuration -->
    <aside class="panel panel-left" id="config-panel" aria-label="Lesson configuration">
      <!-- Content Source -->
      <div class="panel-section">
        <h2 class="section-title" id="source-heading">Content Source</h2>

        <!-- Source Dropdown -->
        <div class="form-group">
          <label for="source-select" class="form-label sr-only">Content source</label>
          <select id="source-select" class="form-select source-select">
            <option value="search">üîç Find Videos</option>
            <option value="youtube">üì∫ YouTube URL</option>
            <option value="upload">üìÅ Upload Audio</option>
          </select>
        </div>

        <!-- Find Videos (Search) - DEFAULT -->
        <div class="source-content" id="source-search" role="tabpanel" aria-labelledby="tab-search">
          <!-- Topic Dropdown -->
          <div class="form-group">
            <label for="topic-select" class="form-label">Topic</label>
            <select id="topic-select" class="form-select">
              <option value="">Select a topic...</option>
              <option value="news">üì∞ News</option>
              <option value="politics">üèõÔ∏è Politics</option>
              <option value="economy">üí∞ Economy</option>
              <option value="culture">üé≠ Culture</option>
              <option value="sports">‚öΩ Sports</option>
              <option value="science">üî¨ Science</option>
              <option value="religion">üïå Religion</option>
              <option value="history">üìú History</option>
              <option value="health">üíä Health</option>
              <option value="education">üìö Education</option>
            </select>
          </div>

          <!-- Duration Filter -->
          <div class="duration-filter">
            <label class="duration-label">Video Length:</label>
            <div class="duration-options">
              <button class="duration-btn active" data-min="0" data-max="0" type="button">Any</button>
              <button class="duration-btn" data-min="0" data-max="60" type="button">&lt;1 min</button>
              <button class="duration-btn" data-min="60" data-max="300" type="button">1-5 min</button>
              <button class="duration-btn" data-min="300" data-max="900" type="button">5-15 min</button>
              <button class="duration-btn" data-min="900" data-max="0" type="button">&gt;15 min</button>
            </div>
          </div>

          <!-- Custom Search (collapsed by default) -->
          <details class="custom-search-details">
            <summary class="custom-search-toggle">Custom search...</summary>
            <div class="custom-search-input">
              <label for="search-query" class="sr-only">Search query</label>
              <input type="search" id="search-query" class="form-input"
                     placeholder="Type your own search..."
                     autocomplete="off"
                     aria-label="Custom search query">
              <button class="btn btn-primary btn-sm" id="search-btn" type="button">Search</button>
            </div>
          </details>

          <!-- Search Results -->
          <div id="search-results" class="video-search-results hidden">
            <div class="search-results-header">
              <span id="search-results-count">0 videos found</span>
              <button class="btn btn-ghost btn-sm" id="clear-search">Clear</button>
            </div>
            <div class="ilr-legend-compact" title="Videos marked with ‚òÖ Good Match are close to your target ILR level">
              <span class="ilr-legend-label">ILR:</span>
              <span class="ilr-legend-item" title="Elementary">1</span>
              <span class="ilr-legend-item" title="Limited Working">2</span>
              <span class="ilr-legend-item" title="Professional">3</span>
              <span class="ilr-legend-help">?</span>
            </div>
            <div id="search-results-grid" class="search-results-grid">
              <!-- Video cards populated by JavaScript -->
            </div>
          </div>

          <!-- Search Loading State (with Stop button) -->
          <div id="search-loading" class="search-loading hidden" role="status" aria-live="polite" aria-busy="true">
            <div class="processing-spinner" aria-hidden="true"></div>
            <span id="search-loading-text">Searching...</span>
            <button class="btn btn-ghost btn-sm" id="stop-search-btn" type="button">Stop</button>
          </div>
        </div>

        <!-- YouTube URL Input (Secondary) -->
        <div class="source-content hidden" id="source-youtube" role="tabpanel" aria-labelledby="tab-youtube">
          <div class="form-group">
            <label class="form-label" for="youtube-url">YouTube URL</label>
            <input type="url" id="youtube-url" class="form-input"
                   placeholder="https://youtube.com/watch?v=..."
                   pattern="https?://(www\.)?(youtube\.com|youtu\.be)/.+"
                   aria-describedby="youtube-hint">
            <p class="form-hint" id="youtube-hint">Works with any Arabic video that has captions</p>
          </div>
        </div>

        <!-- Upload Input -->
        <div class="source-content hidden" id="source-upload" role="tabpanel" aria-labelledby="tab-upload">
          <div id="drop-zone" class="drop-zone" role="button" tabindex="0" aria-label="Upload audio file. Drag and drop or click to upload">
            <span class="drop-icon" aria-hidden="true">&#128193;</span>
            <span>Drag & drop or click to upload</span>
            <input type="file" id="file-input" hidden
                   accept=".mp3,.wav,.m4a,.ogg,.webm,.aac,audio/*"
                   aria-label="Select audio file">
          </div>
          <div id="file-preview" class="file-preview hidden" role="status" aria-live="polite">
            <span aria-hidden="true">&#127925;</span>
            <div class="file-info">
              <div class="file-name" id="file-name"></div>
              <div class="file-size" id="file-size"></div>
            </div>
            <button class="file-remove" id="file-remove" type="button" aria-label="Remove file">&times;</button>
          </div>
        </div>
      </div>

      <!-- Parameters -->
      <div class="panel-section">
        <h2 class="section-title" id="params-heading">Parameters</h2>

        <!-- ILR Level -->
        <div class="field-group">
          <label for="ilr-slider" id="ilr-label">Target ILR Level</label>
          <input type="range" id="ilr-slider" class="form-range"
                 min="1" max="3.5" step="0.5" value="2"
                 aria-labelledby="ilr-label"
                 aria-valuemin="1" aria-valuemax="3.5" aria-valuenow="2"
                 aria-valuetext="ILR Level 2.0 - Limited Working Proficiency">
          <div class="ilr-display" aria-live="polite">
            <div class="ilr-badge-large" id="ilr-value">2.0</div>
            <div class="ilr-info">
              <h3 id="ilr-name">Limited Working Proficiency</h3>
              <p id="ilr-desc">Factual news, personal narratives, simple arguments</p>
            </div>
          </div>
        </div>

      </div>
    </aside>

    <!-- Main Content Area -->
    <section class="main-content" id="content-area" aria-label="Lesson generation workspace">
      <!-- Step Indicator -->
      <nav class="step-indicator" aria-label="Generation progress">
        <div class="step active" data-step="1" aria-current="step">
          <div class="step-number" aria-hidden="true">1</div>
          <span class="step-label">Input</span>
        </div>
        <div class="step-connector" aria-hidden="true"></div>
        <div class="step" data-step="2">
          <div class="step-number" aria-hidden="true">2</div>
          <span class="step-label">Process</span>
        </div>
        <div class="step-connector" aria-hidden="true"></div>
        <div class="step" data-step="3">
          <div class="step-number" aria-hidden="true">3</div>
          <span class="step-label">Review</span>
        </div>
        <div class="step-connector" aria-hidden="true"></div>
        <div class="step" data-step="4">
          <div class="step-number" aria-hidden="true">4</div>
          <span class="step-label">Export</span>
        </div>
      </nav>

      <!-- Content Card - Input State -->
      <div class="content-card" id="input-state">
        <div class="content-card-header">
          <h2 class="content-card-title">Create a New Lesson</h2>
        </div>

        <div id="video-input-state" style="text-align: center; padding: 60px 20px;">
          <div style="font-size: 64px; opacity: 0.3; margin-bottom: 24px;" aria-hidden="true">&#127911;</div>
          <p style="margin-bottom: 12px; font-size: 1.25rem; font-weight: 600;">Ready to Generate</p>
          <p style="color: var(--color-text-secondary); max-width: 400px; margin: 0 auto;">
            Select a content source from the left panel, set your target ILR level and topic,
            then click "Generate Lesson" to begin.
          </p>
        </div>

        <!-- Video Preview (shown when video selected) -->
        <div class="video-preview hidden" id="video-preview">
          <div class="video-thumbnail">
            <img id="video-thumb" src="" alt="Video thumbnail">
            <div class="video-play-overlay">
              <svg width="68" height="48" viewBox="0 0 68 48">
                <path fill="#f00" d="M66.52,7.74c-0.78-2.93-2.49-5.41-5.42-6.19C55.79,.13,34,0,34,0S12.21,.13,6.9,1.55 C3.97,2.33,2.27,4.81,1.48,7.74C0.06,13.05,0,24,0,24s0.06,10.95,1.48,16.26c0.78,2.93,2.49,5.41,5.42,6.19 C12.21,47.87,34,48,34,48s21.79-0.13,27.1-1.55c2.93-0.78,4.64-3.26,5.42-6.19C67.94,34.95,68,24,68,24S67.94,13.05,66.52,7.74z"/>
                <path fill="#fff" d="M 45,24 27,14 27,34"/>
              </svg>
            </div>
            <div class="video-duration-badge" id="video-duration-badge"></div>
          </div>
          <div class="video-info">
            <h3 id="video-title"></h3>
            <p id="video-channel" class="video-channel"></p>
            <div class="video-meta">
              <span id="video-duration"></span>
            </div>
            <div class="video-badges">
              <span class="badge badge-ilr" id="video-ilr" title="Estimated ILR level">ILR ~2.0</span>
              <span class="badge" id="video-captions">Captions available</span>
              <span class="badge" id="video-language" style="display: none;"></span>
            </div>
          </div>
          <!-- Generate button in preview -->
          <div class="video-preview-actions">
            <button class="btn btn-primary btn-lg" id="preview-generate-btn" type="button">
              Generate Lesson
            </button>
            <button class="btn btn-secondary" id="preview-change-btn" type="button">
              Choose Different Video
            </button>
          </div>
        </div>
      </div>

      <!-- Recovery Banner (shown if incomplete lesson found) -->
      <div id="recovery-banner" class="recovery-banner hidden" role="alert">
        <div class="recovery-content">
          <span class="recovery-icon">&#128190;</span>
          <span class="recovery-text">Found an incomplete lesson from earlier.</span>
        </div>
        <div class="recovery-actions">
          <button id="resume-lesson-btn" class="btn btn-primary btn-sm">Resume</button>
          <button id="discard-lesson-btn" class="btn btn-ghost btn-sm">Start Fresh</button>
        </div>
      </div>

      <!-- Content Card - Processing State -->
      <div class="content-card hidden" id="processing-state" role="status" aria-live="polite" aria-atomic="true">
        <div class="processing-container">
          <div class="processing-spinner" aria-hidden="true"></div>
          <div class="processing-status" id="processing-status">Initializing...</div>
          <div class="processing-detail" id="processing-detail">Please wait</div>
          <div class="processing-estimate" id="processing-estimate"></div>

          <div class="processing-progress">
            <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Generation progress">
              <div class="progress-bar-fill" id="progress-fill" style="width: 0%"></div>
            </div>
          </div>

          <!-- Cancel Button -->
          <button id="cancel-generation-btn" class="btn btn-danger btn-sm cancel-btn" type="button">
            Cancel Generation
          </button>

          <div class="processing-steps" id="processing-steps">
            <div class="processing-step" data-step="fetch">
              <div class="processing-step-icon">&#128250;</div>
              <div class="processing-step-text">
                <div class="processing-step-name">Fetch Content</div>
                <div class="processing-step-status">Waiting...</div>
              </div>
            </div>
            <div class="processing-step" data-step="transcribe">
              <div class="processing-step-icon">&#128221;</div>
              <div class="processing-step-text">
                <div class="processing-step-name">Transcribe Audio</div>
                <div class="processing-step-status">Waiting...</div>
              </div>
            </div>
            <div class="processing-step" data-step="analyze">
              <div class="processing-step-icon">&#128200;</div>
              <div class="processing-step-text">
                <div class="processing-step-name">Analyze Content</div>
                <div class="processing-step-status">Waiting...</div>
              </div>
            </div>
            <div class="processing-step" data-step="questions">
              <div class="processing-step-icon">&#10067;</div>
              <div class="processing-step-text">
                <div class="processing-step-name">Generate Questions</div>
                <div class="processing-step-status">Waiting...</div>
              </div>
            </div>
            <div class="processing-step" data-step="assemble">
              <div class="processing-step-icon">&#128230;</div>
              <div class="processing-step-text">
                <div class="processing-step-name">Assemble Lesson</div>
                <div class="processing-step-status">Waiting...</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Content Card - Review State -->
      <div class="content-card hidden" id="review-state">
        <div class="content-card-header">
          <h2 class="content-card-title">Review Lesson</h2>
          <div>
            <button class="btn btn-secondary btn-sm" id="edit-transcript-btn">Edit Transcript</button>
          </div>
        </div>

        <!-- Analysis Summary -->
        <div class="analysis-grid">
          <div class="analysis-card">
            <div class="analysis-label">ILR Level</div>
            <div class="analysis-value" id="result-ilr">2.0</div>
            <div class="analysis-detail" id="result-ilr-name">Limited Working</div>
          </div>
          <div class="analysis-card">
            <div class="analysis-label">Duration</div>
            <div class="analysis-value" id="result-duration">3:45</div>
            <div class="analysis-detail">minutes</div>
          </div>
          <div class="analysis-card">
            <div class="analysis-label">Words</div>
            <div class="analysis-value" id="result-words">342</div>
            <div class="analysis-detail" id="result-unique">187 unique</div>
          </div>
          <div class="analysis-card">
            <div class="analysis-label">Dialect</div>
            <div class="analysis-value" id="result-dialect">MSA</div>
            <div class="analysis-detail">Modern Standard</div>
          </div>
        </div>

        <!-- Transcript Editor with Confidence -->
        <div class="transcript-editor">
          <div class="transcript-editor-header">
            <span class="transcript-editor-title">Transcript (click to edit)</span>
            <div class="confidence-legend">
              <div class="confidence-legend-item">
                <span class="confidence-dot high"></span>
                <span>High confidence</span>
              </div>
              <div class="confidence-legend-item">
                <span class="confidence-dot medium"></span>
                <span>Review suggested</span>
              </div>
              <div class="confidence-legend-item">
                <span class="confidence-dot low"></span>
                <span>Needs correction</span>
              </div>
            </div>
          </div>
          <div class="editable-transcript" id="transcript-preview">
            <!-- Populated by JavaScript with confidence-colored segments -->
          </div>
          <div class="transcript-save-status" id="transcript-save-status">
            <span>Changes auto-saved</span>
          </div>
        </div>

        <!-- Questions Preview -->
        <div style="margin-top: 24px;">
          <h3 style="margin-bottom: 12px;">Generated Questions</h3>

          <div class="questions-section">
            <h4>
              <span>Pre-Listening</span>
              <span class="question-count" id="pre-count">2</span>
            </h4>
            <div id="pre-questions">
              <!-- Populated by JavaScript -->
            </div>
          </div>

          <div class="questions-section">
            <h4>
              <span>While-Listening</span>
              <span class="question-count" id="while-count">8</span>
            </h4>
            <div id="while-questions">
              <!-- Populated by JavaScript -->
            </div>
          </div>

          <div class="questions-section">
            <h4>
              <span>Post-Listening</span>
              <span class="question-count" id="post-count">4</span>
            </h4>
            <div id="post-questions">
              <!-- Populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>

      <!-- Action Bar -->
      <div class="action-bar" id="action-bar" role="toolbar" aria-label="Lesson actions">
        <div class="action-group">
          <button class="btn btn-ghost" id="back-btn" type="button" disabled>Back</button>
          <button class="btn btn-danger" id="start-over-btn" type="button" title="Clear everything and start fresh">Start Over</button>
          <button class="btn btn-ghost" id="reset-quota-btn" type="button" title="Reset LLM quotas if you ran out">Reset LLM Quota</button>
        </div>
        <div class="action-group">
          <button class="btn btn-secondary" id="preview-btn" type="button" disabled>Preview</button>
          <button class="btn btn-primary" id="export-btn" type="button" disabled>Export Lesson</button>
        </div>
      </div>
    </section>

    <!-- Right Panel: Status & Help -->
    <aside class="panel panel-right" id="status-panel" aria-label="Status and help">
      <div class="panel-section">
        <h2 class="section-title" id="quota-heading">LLM Quota</h2>

        <div class="status-card" data-provider="google">
          <div class="status-header">
            <div class="status-indicator"></div>
            <span class="status-title">Google AI Studio</span>
          </div>
          <div class="quota-bar">
            <div class="quota-fill" id="quota-fill-google" style="width: 100%"></div>
          </div>
          <div class="quota-text" id="quota-text-google">250 / 250 requests remaining today</div>
        </div>

        <div class="status-card" data-provider="groq">
          <div class="status-header">
            <div class="status-indicator"></div>
            <span class="status-title">Groq</span>
          </div>
          <div class="quota-bar">
            <div class="quota-fill" id="quota-fill-groq" style="width: 100%"></div>
          </div>
          <div class="quota-text" id="quota-text-groq">1,000 / 1,000 requests remaining</div>
        </div>

        <div class="status-card" data-provider="openrouter">
          <div class="status-header">
            <div class="status-indicator"></div>
            <span class="status-title">OpenRouter</span>
          </div>
          <div class="quota-bar">
            <div class="quota-fill" id="quota-fill-openrouter" style="width: 100%"></div>
          </div>
          <div class="quota-text" id="quota-text-openrouter">50 / 50 requests remaining</div>
        </div>
      </div>

      <div class="panel-section">
        <h2 class="section-title">Tips</h2>

        <div class="tips-card">
          <div class="tips-title">Getting the Best Results</div>
          <ul class="tips-list">
            <li>Choose videos with clear audio and minimal background noise</li>
            <li>YouTube videos with existing captions work best</li>
            <li>Keep duration under 5 minutes for faster processing</li>
            <li>Select the appropriate ILR level for your students</li>
          </ul>
        </div>
      </div>

      <div class="panel-section">
        <h2 class="section-title">About ILR Levels</h2>

        <div class="status-card">
          <p style="font-size: var(--text-sm); color: var(--color-text-secondary); margin-bottom: 12px;">
            The Interagency Language Roundtable (ILR) scale is the standard grading scale for
            language proficiency in the US government.
          </p>
          <a href="about.html#ilr" class="btn btn-ghost btn-sm" style="width: 100%;">
            Learn More
          </a>
        </div>
      </div>
    </aside>
  </main>

  <!-- Mobile Toolbar -->
  <nav class="mobile-toolbar" role="tablist" aria-label="Mobile panel navigation">
    <button class="mobile-toolbar-btn active" data-panel="config" role="tab" aria-selected="true" type="button">
      <span style="font-size: 20px;" aria-hidden="true">&#9881;</span>
      <span>Config</span>
    </button>
    <button class="mobile-toolbar-btn" data-panel="main" role="tab" aria-selected="false" type="button">
      <span style="font-size: 20px;" aria-hidden="true">&#128221;</span>
      <span>Content</span>
    </button>
    <button class="mobile-toolbar-btn" data-panel="status" role="tab" aria-selected="false" type="button">
      <span style="font-size: 20px;" aria-hidden="true">&#128200;</span>
      <span>Status</span>
    </button>
  </nav>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container" role="status" aria-live="polite" aria-atomic="true"></div>

  <!-- Scripts -->
  <script type="module">
    import { EventBus, Events } from './js/core/event-bus.js';
    import { StateManager } from './js/core/state-manager.js';
    import { Config } from './js/core/config.js';
    import { extractYouTubeId, formatTime, $, getActionableError } from './js/core/utils.js';
    import { lessonGeneratorWorkflow } from './js/workflows/lesson-generator-workflow.js';
    import { initAuthUI } from './js/ui/auth-ui.js';
    import { initSettingsPanel } from './js/ui/settings-panel.js';

    // Initialize auth and settings
    initAuthUI();
    initSettingsPanel();

    // XSS prevention helper
    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }

    // ========================================
    // PHASE 1: Cancellation & Progressive Save
    // ========================================

    // Global abort controller for cancellable generation
    let generationAbortController = null;

    // Progressive save database
    const PROGRESS_DB_NAME = 'TanaghumProgress';
    const PROGRESS_STORE = 'lessonProgress';

    /**
     * Open IndexedDB for progress saving
     */
    async function openProgressDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(PROGRESS_DB_NAME, 1);
        request.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(PROGRESS_STORE)) {
            db.createObjectStore(PROGRESS_STORE, { keyPath: 'id' });
          }
        };
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    /**
     * Save generation progress after each step
     */
    async function saveProgress(step, data) {
      try {
        const db = await openProgressDB();
        const tx = db.transaction(PROGRESS_STORE, 'readwrite');
        const store = tx.objectStore(PROGRESS_STORE);

        const existing = await new Promise(resolve => {
          const req = store.get('current');
          req.onsuccess = () => resolve(req.result || { id: 'current' });
          req.onerror = () => resolve({ id: 'current' });
        });

        existing[step] = data;
        existing.lastStep = step;
        existing.timestamp = Date.now();
        existing.sourceType = StateManager.get('source.type');
        existing.sourceUrl = StateManager.get('source.url');
        existing.videoTitle = StateManager.get('source.metadata.title');

        await new Promise((resolve, reject) => {
          const req = store.put(existing);
          req.onsuccess = resolve;
          req.onerror = () => reject(req.error);
        });

        db.close();
        console.log(`[Progress] Saved step: ${step}`);
      } catch (error) {
        console.warn('[Progress] Failed to save:', error);
      }
    }

    /**
     * Check for incomplete lesson
     */
    async function checkForIncompleteLesson() {
      try {
        const db = await openProgressDB();
        const tx = db.transaction(PROGRESS_STORE, 'readonly');
        const store = tx.objectStore(PROGRESS_STORE);

        return new Promise(resolve => {
          const req = store.get('current');
          req.onsuccess = () => {
            db.close();
            const progress = req.result;
            // Only show recovery if within last 24 hours
            if (progress && progress.timestamp > Date.now() - 86400000) {
              resolve(progress);
            } else {
              resolve(null);
            }
          };
          req.onerror = () => {
            db.close();
            resolve(null);
          };
        });
      } catch {
        return null;
      }
    }

    /**
     * Clear saved progress
     */
    async function clearProgress() {
      try {
        const db = await openProgressDB();
        const tx = db.transaction(PROGRESS_STORE, 'readwrite');
        const store = tx.objectStore(PROGRESS_STORE);
        await new Promise(resolve => {
          const req = store.delete('current');
          req.onsuccess = resolve;
          req.onerror = resolve;
        });
        db.close();
      } catch (error) {
        console.warn('[Progress] Failed to clear:', error);
      }
    }

    /**
     * Estimate generation time based on content
     */
    function estimateGenerationTime(source) {
      const duration = source?.metadata?.duration || 180; // Default 3 min
      const durationMins = duration / 60;

      // Base times in seconds
      const transcriptTime = 30 + (durationMins * 15); // 30s base + 15s per minute
      const vocabTime = 10;
      const questionsTime = 20;
      const assemblyTime = 5;

      const totalSeconds = transcriptTime + vocabTime + questionsTime + assemblyTime;
      const mins = Math.floor(totalSeconds / 60);
      const secs = Math.floor(totalSeconds % 60);

      return mins > 0 ? `~${mins}m ${secs}s` : `~${secs}s`;
    }

    // Check for incomplete lesson on page load
    (async function checkRecovery() {
      const incomplete = await checkForIncompleteLesson();
      if (incomplete && incomplete.lastStep) {
        const banner = $('#recovery-banner');
        const steps = { fetch: 1, transcribe: 2, analyze: 3, questions: 4, assemble: 5 };
        const stepNum = steps[incomplete.lastStep] || 1;
        const title = incomplete.videoTitle || 'an earlier session';

        banner.querySelector('.recovery-text').textContent =
          `Found incomplete lesson from ${title} (Step ${stepNum}/5)`;
        banner.classList.remove('hidden');
      }
    })();

    // Recovery banner handlers
    $('#resume-lesson-btn')?.addEventListener('click', async () => {
      const progress = await checkForIncompleteLesson();
      if (progress) {
        // Restore state from progress
        if (progress.transcription) {
          StateManager.set('transcription', progress.transcription);
        }
        if (progress.vocabulary) {
          StateManager.set('vocabulary', progress.vocabulary);
        }
        if (progress.questions) {
          StateManager.set('questions', progress.questions);
        }

        showToast('info', 'Resuming', 'Continuing from where you left off...');
        $('#recovery-banner').classList.add('hidden');

        // Continue generation from last step
        showProcessingState();
      }
    });

    $('#discard-lesson-btn')?.addEventListener('click', async () => {
      await clearProgress();
      $('#recovery-banner').classList.add('hidden');
      showToast('info', 'Cleared', 'Starting fresh');
    });

    // Cancel generation button
    $('#cancel-generation-btn')?.addEventListener('click', () => {
      if (generationAbortController) {
        generationAbortController.abort();
        generationAbortController = null;
        showToast('info', 'Cancelled', 'Generation cancelled');

        // Return to input state
        $('#processing-state').classList.add('hidden');
        $('#input-state').classList.remove('hidden');

        // Reset step indicators
        document.querySelectorAll('.step').forEach((step, i) => {
          step.classList.remove('active', 'completed');
          if (i === 0) step.classList.add('active');
        });
      }
    });

    // Error handling for module imports
    window.addEventListener('error', (e) => {
      if (e.message && e.message.includes('import')) {
        console.error('Module loading error:', e.message);
        const container = document.getElementById('toast-container');
        if (container) {
          const toast = document.createElement('div');
          toast.className = 'toast toast-error';
          toast.innerHTML = '<div class="toast-content"><div class="toast-title">Loading Error</div><div class="toast-message">Failed to load application modules. Please refresh the page.</div></div>';
          container.appendChild(toast);
        }
      }
    });

    // ILR Level data
    const ILR_DATA = {
      '1': { name: 'Elementary', desc: 'Short, simple texts with familiar vocabulary' },
      '1.5': { name: 'Elementary+', desc: 'Simple conversations on routine topics' },
      '2': { name: 'Limited Working', desc: 'Factual news, personal narratives, simple arguments' },
      '2.5': { name: 'Limited Working+', desc: 'Standard news, formal speeches, extended arguments' },
      '3': { name: 'General Professional', desc: 'Political analysis, technical discussions' },
      '3.5': { name: 'General Professional+', desc: 'Complex argumentation, nuanced content' }
    };

    // DOM elements
    const sourceSelect = $('#source-select');
    const sourceContents = document.querySelectorAll('.source-content');
    const topicSelect = $('#topic-select');
    const ilrSlider = $('#ilr-slider');
    const youtubeInput = $('#youtube-url');
    const dropZone = $('#drop-zone');
    const fileInput = $('#file-input');

    // Source dropdown switching
    sourceSelect.addEventListener('change', () => {
      const source = sourceSelect.value;
      sourceContents.forEach(content => {
        content.classList.toggle('hidden', !content.id.includes(source));
      });
      // Hide search results when switching away from search mode
      if (source !== 'search') {
        $('#search-results')?.classList.add('hidden');
      }
      StateManager.set('source.type', source);
    });

    // Topic dropdown selection
    topicSelect.addEventListener('change', () => {
      const topic = topicSelect.value;
      if (topic) {
        StateManager.set('params.topic', topic);
        // Auto-search when topic is selected
        performTopicSearch(topic);
      }
    });

    // ILR slider
    ilrSlider.addEventListener('input', () => {
      const value = ilrSlider.value;
      const data = ILR_DATA[value];
      $('#ilr-value').textContent = parseFloat(value).toFixed(1);
      $('#ilr-name').textContent = data.name;
      $('#ilr-desc').textContent = data.desc;
      StateManager.set('params.targetIlr', parseFloat(value));
    });

    // File upload
    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      if (e.dataTransfer.files.length) {
        handleFile(e.dataTransfer.files[0]);
      }
    });

    fileInput.addEventListener('change', () => {
      if (fileInput.files.length) {
        handleFile(fileInput.files[0]);
      }
    });

    function handleFile(file) {
      // Validate file type
      const validTypes = ['audio/mp3', 'audio/mpeg', 'audio/wav', 'audio/m4a', 'audio/ogg', 'audio/webm'];
      if (!validTypes.includes(file.type) && !file.name.match(/\.(mp3|wav|m4a|ogg|webm|aac)$/i)) {
        showToast('error', 'Invalid file type', 'Please upload an audio file');
        fileInput.value = '';
        return;
      }

      // Check file size (100MB max)
      if (file.size > 100 * 1024 * 1024) {
        showToast('error', 'File too large', 'Maximum file size is 100MB');
        fileInput.value = '';
        return;
      }

      // Show preview
      $('#file-name').textContent = file.name;
      $('#file-size').textContent = formatBytes(file.size);
      $('#file-preview').classList.remove('hidden');
      dropZone.classList.add('hidden');

      StateManager.set('source.file', file);
    }

    // Duplicates utils.js formatBytes, but needed here since this is an inline script (not ES module scope)
    function formatBytes(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    $('#file-remove')?.addEventListener('click', () => {
      StateManager.set('source.file', null);
      fileInput.value = '';
      $('#file-preview').classList.add('hidden');
      dropZone.classList.remove('hidden');
    });

    // YouTube URL validation and preview
    let currentVideoId = null;

    youtubeInput.addEventListener('input', debounce(async () => {
      const url = youtubeInput.value.trim();
      const videoId = extractYouTubeId(url);

      // Hide preview if URL cleared or invalid
      if (!videoId) {
        hideVideoPreview();
        currentVideoId = null;
        return;
      }

      // Skip if same video
      if (videoId === currentVideoId) return;
      currentVideoId = videoId;

      // Show loading state
      showVideoLoading();

      try {
        // Fetch video metadata from worker
        const response = await fetch(`${Config.WORKER_URL}/api/youtube/metadata?v=${videoId}`);
        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        // Update state
        StateManager.set('source', {
          type: 'youtube',
          url: url,
          videoId: videoId,
          metadata: data
        });

        // Display video preview
        showVideoPreview(data);

        showToast('success', 'Video found', data.captions?.available ? 'Captions available' : 'Will need transcription');

      } catch (error) {
        console.error('Failed to fetch video:', error);
        hideVideoPreview();
        showToast('error', 'Video not found', error.message || 'Could not load video metadata');
        currentVideoId = null;
      }
    }, 500));

    function showVideoLoading() {
      const preview = $('#video-preview');
      const placeholder = preview.previousElementSibling;

      placeholder.classList.add('hidden');
      preview.classList.remove('hidden');

      $('#video-thumb').src = '';
      $('#video-thumb').alt = 'Loading...';
      $('#video-title').textContent = 'Loading video...';
      $('#video-channel').textContent = '';
      $('#video-duration').textContent = '';
      $('#video-captions').textContent = 'Checking captions...';
      $('#video-captions').className = 'badge';
    }

    function showVideoPreview(data) {
      const preview = $('#video-preview');
      const placeholder = preview.previousElementSibling;

      placeholder.classList.add('hidden');
      preview.classList.remove('hidden');

      // Set thumbnail
      $('#video-thumb').src = data.thumbnail || `https://i.ytimg.com/vi/${data.videoId}/hqdefault.jpg`;
      $('#video-thumb').alt = data.title;

      // Set title and channel
      $('#video-title').textContent = data.title || 'Untitled Video';
      $('#video-channel').textContent = data.author || 'Unknown Channel';

      // Set duration
      if (data.duration) {
        const mins = Math.floor(data.duration / 60);
        const secs = data.duration % 60;
        $('#video-duration').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

        // Warning if too long
        if (data.duration > 600) {
          showToast('warning', 'Long video', 'Videos over 10 minutes may take a while to process');
        }
      } else {
        $('#video-duration').textContent = '';
      }

      // Set captions badge
      const captionsBadge = $('#video-captions');
      if (data.captions?.available) {
        captionsBadge.textContent = 'Captions available';
        captionsBadge.className = 'badge badge-success';
      } else {
        captionsBadge.textContent = 'No captions - will transcribe';
        captionsBadge.className = 'badge badge-warning';
      }

      // Estimate and display ILR level
      const estimatedIlr = estimateVideoIlr({
        title: data.title,
        channel: data.author,
        durationSeconds: data.duration
      });
      const ilrBadge = $('#video-ilr');
      if (ilrBadge) {
        ilrBadge.textContent = `ILR ~${estimatedIlr.toFixed(1)}`;

        // Color based on match with target
        const targetIlr = StateManager.get('params.targetIlr') || 2.0;
        const isMatch = Math.abs(estimatedIlr - targetIlr) <= 0.5;
        ilrBadge.className = isMatch
          ? 'badge badge-ilr badge-success'
          : 'badge badge-ilr';
      }
    }

    function hideVideoPreview() {
      const preview = $('#video-preview');
      const placeholder = preview.previousElementSibling;

      preview.classList.add('hidden');
      placeholder.classList.remove('hidden');
    }

    // Duplicates utils.js debounce, but needed here since this is an inline script (not ES module scope)
    function debounce(fn, ms) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn(...args), ms);
      };
    }

    function startGeneration() {
      const source = StateManager.get('source');
      const sourceType = source?.type;

      // Check if we have a valid source
      if (sourceType === 'youtube' || sourceType === 'search') {
        // For YouTube/search, we need either a videoId or a URL in the input
        if (!source?.videoId && !youtubeInput.value.trim()) {
          showToast('error', 'No video selected', 'Please select a video or enter a YouTube URL');
          return;
        }
        // If we have input but no videoId, use the input URL
        if (!source?.videoId && youtubeInput.value.trim()) {
          // Will be processed by the workflow
        }
      }

      if (sourceType === 'upload' && !source?.file) {
        showToast('error', 'No file', 'Please upload an audio file');
        return;
      }

      // Start processing
      showProcessingState();
    }

    function showProcessingState() {
      $('#input-state').classList.add('hidden');
      $('#processing-state').classList.remove('hidden');
      $('#recovery-banner').classList.add('hidden');

      // Show time estimate
      const source = StateManager.get('source');
      const estimate = estimateGenerationTime(source);
      const estimateEl = $('#processing-estimate');
      if (estimateEl) {
        estimateEl.textContent = `Estimated time: ${estimate}`;
      }

      // Update step indicator
      document.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active', 'completed');
      });
      document.querySelector('[data-step="1"]').classList.add('completed');
      document.querySelector('[data-step="2"]').classList.add('active');

      // Create abort controller for this generation
      generationAbortController = new AbortController();

      // Start processing
      simulateProcessing();
    }

    async function simulateProcessing() {
      const steps = ['fetch', 'transcribe', 'analyze', 'questions', 'assemble'];
      const stepMessages = {
        fetch: { status: 'Fetching content...', detail: 'Connecting to source' },
        transcribe: { status: 'Transcribing audio...', detail: 'Using Whisper model' },
        analyze: { status: 'Analyzing content...', detail: 'Calculating ILR level' },
        questions: { status: 'Generating questions...', detail: 'Creating comprehension exercises' },
        assemble: { status: 'Assembling lesson...', detail: 'Preparing final output' }
      };

      // Get source and parameters from state
      const source = StateManager.get('source');
      const targetIlr = StateManager.get('params.targetIlr') || 2.0;
      const topic = StateManager.get('params.topic') || 'general';

      // Track completed steps for progressive saving
      let lastCompletedStep = null;

      try {
        // Start the real workflow with abort signal
        await lessonGeneratorWorkflow.generate({
          source,
          targetIlr,
          topic,
          signal: generationAbortController?.signal,
          onProgress: async (progress) => {
            const { step, percent, message, stage, data } = progress;

            // Check if cancelled
            if (generationAbortController?.signal?.aborted) {
              throw new DOMException('Generation cancelled', 'AbortError');
            }

            // Update current step status
            const stepEl = document.querySelector(`[data-step="${step}"]`);
            if (stepEl) {
              // Mark previous steps as completed
              const currentIndex = steps.indexOf(step);
              steps.slice(0, currentIndex).forEach(s => {
                const el = document.querySelector(`[data-step="${s}"]`);
                if (el) {
                  el.classList.remove('active');
                  el.classList.add('completed');
                  el.querySelector('.processing-step-status').textContent = 'Complete';
                }
              });

              // Mark current step as active
              stepEl.classList.add('active');
              stepEl.classList.remove('completed');
              stepEl.querySelector('.processing-step-status').textContent = 'In progress...';
            }

            // Update main status text
            const msg = stepMessages[step];
            if (msg) {
              $('#processing-status').textContent = msg.status;
              $('#processing-detail').textContent = message || stage || msg.detail;
            }

            // Update progress bar
            $('#progress-fill').style.width = `${percent}%`;

            // Progressive save when step completes (percent reaches next threshold)
            if (step !== lastCompletedStep && data) {
              lastCompletedStep = step;
              await saveProgress(step, data);
            }

            // Show streaming transcript if available
            if (step === 'transcribe' && progress.currentText) {
              // Could show streaming text here if UI supports it
              console.log('Transcription progress:', progress.currentText);
            }
          }
        });

        // Mark all steps complete
        steps.forEach(s => {
          const el = document.querySelector(`[data-step="${s}"]`);
          if (el) {
            el.classList.remove('active');
            el.classList.add('completed');
            el.querySelector('.processing-step-status').textContent = 'Complete';
          }
        });

        // Clear saved progress (generation completed successfully)
        await clearProgress();

        // Clean up abort controller
        generationAbortController = null;

        // Show review state with real data
        showReviewStateWithLesson();

      } catch (error) {
        console.error('Lesson generation failed:', error);

        // Check if it was a cancellation
        if (error.name === 'AbortError') {
          // Already handled by cancel button
          return;
        }

        // Get actionable error message
        const actionable = error.actionable || getActionableError(error);

        // Show error with action suggestion
        showToast('error', actionable.title, `${actionable.message} ${actionable.action}`);

        // Show error state
        $('#processing-state').classList.add('hidden');
        $('#input-state').classList.remove('hidden');

        // Reset step indicators
        document.querySelectorAll('.step').forEach((step, i) => {
          step.classList.remove('active', 'completed');
          if (i === 0) step.classList.add('active');
        });

        // Clean up abort controller
        generationAbortController = null;
      }
    }

    function showReviewStateWithLesson() {
      $('#processing-state').classList.add('hidden');
      $('#review-state').classList.remove('hidden');

      // Update step indicator
      document.querySelector('[data-step="2"]').classList.remove('active');
      document.querySelector('[data-step="2"]').classList.add('completed');
      document.querySelector('[data-step="3"]').classList.add('active');

      // Enable buttons
      $('#back-btn').disabled = false;
      $('#preview-btn').disabled = false;
      $('#export-btn').disabled = false;

      // Populate with real lesson data
      const lesson = StateManager.get('lesson');
      if (lesson) {
        populateLessonData(lesson);
      } else {
        // Fallback to sample data if something went wrong
        populateSampleData();
      }
    }

    function getConfidenceClass(confidence) {
      // Map confidence score to CSS class
      if (confidence >= 0.85) return 'confidence-high';
      if (confidence >= 0.6) return 'confidence-medium';
      return 'confidence-low';
    }

    function populateLessonData(lesson) {
      // Populate transcript with confidence-based coloring
      const transcriptHtml = lesson.content.transcript.segments.map((seg, idx) => {
        const confidence = seg.confidence || 0.8;
        const confidenceClass = getConfidenceClass(confidence);
        const confidencePercent = Math.round(confidence * 100);

        return `
          <div class="transcript-segment ${confidenceClass}"
               data-index="${idx}"
               data-start="${seg.start}"
               data-end="${seg.end || seg.start + 5}"
               data-confidence="${confidence}"
               title="Confidence: ${confidencePercent}%">
            <span class="segment-time">${formatTime(seg.start)}</span>
            <span class="segment-text" contenteditable="true" dir="rtl" lang="ar">${seg.text}</span>
          </div>
        `;
      }).join('');

      $('#transcript-preview').innerHTML = transcriptHtml;

      // Add edit handlers for transcript segments
      setupTranscriptEditing(lesson);

      // Update analysis cards with actual lesson data
      const duration = lesson.metadata?.duration || lesson.audio?.duration || 0;
      const mins = Math.floor(duration / 60);
      const secs = Math.floor(duration % 60);
      $('#result-duration').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

      // Always compute word count from transcript text (metadata.wordCount can be stale/wrong)
      const text = lesson.content?.transcript?.text || '';
      const words = text.split(/\s+/).filter(w => w.length > 0);
      const uniqueWords = new Set(words.map(w => w.replace(/[\u064B-\u065F]/g, ''))); // Remove diacritics for comparison
      $('#result-words').textContent = words.length;
      $('#result-unique').textContent = `${uniqueWords.size} unique`;

      // Update dialect
      const dialect = lesson.content?.dialect?.detected || 'msa';
      const dialectNames = {
        'msa': { short: 'MSA', full: 'Modern Standard' },
        'egyptian': { short: 'Egyptian', full: 'Egyptian Arabic' },
        'levantine': { short: 'Levantine', full: 'Levantine Arabic' },
        'gulf': { short: 'Gulf', full: 'Gulf Arabic' },
        'maghrebi': { short: 'Maghrebi', full: 'Maghrebi Arabic' }
      };
      const dialectInfo = dialectNames[dialect] || dialectNames['msa'];
      $('#result-dialect').textContent = dialectInfo.short;
      $('#result-dialect').nextElementSibling.textContent = dialectInfo.full;

      // Populate questions
      ['pre', 'while', 'post'].forEach(phase => {
        const questions = lesson.content.questions[phase];
        const container = $(`#${phase}-questions`);
        const countEl = $(`#${phase}-count`);

        countEl.textContent = questions.length;

        container.innerHTML = questions.map((q, i) => `
          <div class="question-item">
            <div class="question-number">${i + 1}</div>
            <div class="question-content">
              <div class="question-text">
                <div class="question-text-ar">${escapeHtml(q.question_text.ar)}</div>
                <div class="question-text-en">${escapeHtml(q.question_text.en)}</div>
              </div>
              <span class="question-type">${escapeHtml(q.type.replace(/_/g, ' '))}</span>
            </div>
          </div>
        `).join('');
      });

      // Show success message
      showToast('success', 'Lesson Generated!', 'Your lesson is ready to preview');
    }

    function setupTranscriptEditing(lesson) {
      const statusEl = $('#transcript-save-status');
      let saveTimeout = null;

      // Handle edits to transcript segments
      $('#transcript-preview').addEventListener('input', (e) => {
        if (e.target.classList.contains('segment-text')) {
          const segment = e.target.closest('.transcript-segment');
          const index = parseInt(segment.dataset.index, 10);
          const newText = e.target.textContent.trim();

          // Update the lesson data
          if (lesson.content.transcript.segments[index]) {
            lesson.content.transcript.segments[index].text = newText;

            // Mark as user-corrected (high confidence now)
            lesson.content.transcript.segments[index].confidence = 1.0;
            lesson.content.transcript.segments[index].userCorrected = true;

            // Update visual styling to high confidence
            segment.classList.remove('confidence-low', 'confidence-medium');
            segment.classList.add('confidence-high');
            segment.dataset.confidence = '1.0';
            segment.title = 'Confidence: 100% (corrected)';
          }

          // Update state
          StateManager.set('lesson', lesson);

          // Show saving status
          statusEl.innerHTML = '<span class="saving">Saving...</span>';

          // Debounce the "saved" status
          clearTimeout(saveTimeout);
          saveTimeout = setTimeout(() => {
            statusEl.innerHTML = '<span class="saved">‚úì Changes saved</span>';
          }, 500);
        }
      });

      // Handle focus for accessibility
      $('#transcript-preview').addEventListener('focus', (e) => {
        if (e.target.classList.contains('segment-text')) {
          e.target.closest('.transcript-segment').classList.add('editing');
        }
      }, true);

      $('#transcript-preview').addEventListener('blur', (e) => {
        if (e.target.classList.contains('segment-text')) {
          e.target.closest('.transcript-segment').classList.remove('editing');
        }
      }, true);
    }

    // showReviewState removed - now using showReviewStateWithLesson from simulateProcessing

    function populateSampleData() {
      // Sample transcript with varied confidence levels to demonstrate the feature
      const sampleTranscript = [
        { start: 0, text: 'ÿ¥ŸáÿØ ÿßŸÑÿßŸÇÿ™ÿµÿßÿØ ÿßŸÑÿπÿ±ÿ®Ÿä ŸÜŸÖŸàÿßŸã ŸÖŸÑÿ≠Ÿàÿ∏ÿßŸã ŸÅŸä ÿßŸÑÿ≥ŸÜŸàÿßÿ™ ÿßŸÑÿ£ÿÆŸäÿ±ÿ©', confidence: 0.95 },
        { start: 8, text: 'ŸàŸÇÿØ ÿ≥ÿßŸáŸÖÿ™ ÿπÿØÿ© ÿπŸàÿßŸÖŸÑ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÜŸÖŸà ÿßŸÑÿßŸÇÿ™ÿµÿßÿØŸä', confidence: 0.72 },
        { start: 15, text: 'ŸÖŸÜ ÿ£ŸáŸÖŸáÿß ÿßÿ±ÿ™ŸÅÿßÿπ ÿ£ÿ≥ÿπÿßÿ± ÿßŸÑŸÜŸÅÿ∑ ŸàÿßŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±ÿßÿ™ ÿßŸÑÿ£ÿ¨ŸÜÿ®Ÿäÿ©', confidence: 0.45 },
        { start: 23, text: 'ŸÉŸÖÿß ŸÑÿπÿ®ÿ™ ÿßŸÑÿ•ÿµŸÑÿßÿ≠ÿßÿ™ ÿßŸÑÿßŸÇÿ™ÿµÿßÿØŸäÿ© ÿØŸàÿ±ÿßŸã ŸÖŸáŸÖÿßŸã ŸÅŸä ÿ™ÿπÿ≤Ÿäÿ≤ ÿßŸÑŸÜŸÖŸà', confidence: 0.88 }
      ];

      const transcriptHtml = sampleTranscript.map((seg, idx) => {
        const confidenceClass = getConfidenceClass(seg.confidence);
        const confidencePercent = Math.round(seg.confidence * 100);

        return `
          <div class="transcript-segment ${confidenceClass}"
               data-index="${idx}"
               data-start="${seg.start}"
               data-confidence="${seg.confidence}"
               title="Confidence: ${confidencePercent}%">
            <span class="segment-time">${formatTime(seg.start)}</span>
            <span class="segment-text" contenteditable="true" dir="rtl" lang="ar">${seg.text}</span>
          </div>
        `;
      }).join('');

      $('#transcript-preview').innerHTML = transcriptHtml;

      // Sample questions
      const sampleQuestions = {
        pre: [
          { ar: 'ŸÖÿßÿ∞ÿß ÿ™ÿ™ŸàŸÇÿπ ÿ£ŸÜ ŸäŸÜÿßŸÇÿ¥ Ÿáÿ∞ÿß ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑÿü', en: 'What do you expect this recording to discuss?', type: 'multiple_choice' },
          { ar: 'ŸÖÿß ŸáŸä ŸÖÿπŸÑŸàŸÖÿßÿ™ŸÉ ÿßŸÑÿ≥ÿßÿ®ŸÇÿ© ÿπŸÜ ÿßŸÑÿßŸÇÿ™ÿµÿßÿØ ÿßŸÑÿπÿ±ÿ®Ÿäÿü', en: 'What do you already know about the Arab economy?', type: 'open_ended' }
        ],
        while: [
          { ar: 'ŸÖÿß ÿßŸÑŸÅŸÉÿ±ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© ŸÑŸáÿ∞ÿß ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑÿü', en: 'What is the main idea of this recording?', type: 'multiple_choice' },
          { ar: 'ÿ∞ŸÉÿ± ÿßŸÑŸÖÿ™ÿ≠ÿØÿ´ ÿπÿØÿ© ÿπŸàÿßŸÖŸÑ. ÿµÿ≠ ÿ£ŸÖ ÿÆÿ∑ÿ£ÿü', en: 'The speaker mentioned several factors. True or false?', type: 'true_false' }
        ],
        post: [
          { ar: 'ŸÖÿß ŸÖŸàŸÇŸÅ ÿßŸÑŸÖÿ™ÿ≠ÿØÿ´ ŸÖŸÜ ÿßŸÑŸÖŸàÿ∂Ÿàÿπÿü', en: "What is the speaker's attitude toward the topic?", type: 'multiple_choice' },
          { ar: 'ŸÑÿÆÿµ ÿßŸÑŸÅŸÉÿ±ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© ŸÅŸä ÿ¨ŸÖŸÑÿ© Ÿàÿßÿ≠ÿØÿ©', en: 'Summarize the main idea in one sentence', type: 'open_ended' }
        ]
      };

      Object.entries(sampleQuestions).forEach(([phase, questions]) => {
        const container = $(`#${phase}-questions`);
        const countEl = $(`#${phase}-count`);
        countEl.textContent = questions.length;

        container.innerHTML = questions.map((q, i) => `
          <div class="question-item">
            <div class="question-number">${i + 1}</div>
            <div class="question-content">
              <div class="question-text">
                <div class="question-text-ar">${q.ar}</div>
                <div class="question-text-en">${q.en}</div>
              </div>
              <span class="question-type">${q.type.replace('_', ' ')}</span>
            </div>
          </div>
        `).join('');
      });
    }

    // Start Over button - clear everything and reset to initial state
    $('#start-over-btn').addEventListener('click', () => {
      if (!confirm('Are you sure you want to start over? This will clear all your current work.')) {
        return;
      }

      // Clear session storage
      StateManager.clearSession();

      // Reset state to defaults
      StateManager.reset();

      // Clear localStorage items
      localStorage.removeItem('tanaghum_current_lesson');
      localStorage.removeItem('tanaghum_session');

      // Reset UI to input state
      $('#input-state').classList.remove('hidden');
      $('#processing-state').classList.add('hidden');
      $('#review-state').classList.add('hidden');

      // Reset step indicators
      document.querySelectorAll('.step').forEach((step, i) => {
        step.classList.remove('active', 'completed');
        if (i === 0) step.classList.add('active');
      });

      // Reset action buttons
      $('#back-btn').disabled = true;
      $('#preview-btn').disabled = true;
      $('#export-btn').disabled = true;

      // Clear video preview
      hideVideoPreview();

      // Reset source dropdown to search
      const sourceSelect = $('#source-select');
      if (sourceSelect) sourceSelect.value = 'search';
      document.querySelectorAll('.source-content').forEach(content => {
        content.classList.toggle('hidden', !content.id.includes('search'));
      });

      // Clear search results
      const searchResultsGrid = $('#search-results-grid');
      if (searchResultsGrid) searchResultsGrid.innerHTML = '';
      $('#search-results')?.classList.add('hidden');

      // Clear YouTube input
      const youtubeInput = $('#youtube-url');
      if (youtubeInput) youtubeInput.value = '';

      // Reset file upload state
      $('#file-preview')?.classList.add('hidden');
      dropZone?.classList.remove('hidden');
      if (fileInput) fileInput.value = '';

      // Clear recovery banner
      $('#recovery-banner')?.classList.add('hidden');

      // Show toast
      showToast('success', 'Reset Complete', 'Ready to start a new lesson');
    });

    // Reset LLM Quota button
    $('#reset-quota-btn').addEventListener('click', async () => {
      try {
        const { llmClient } = await import('./js/generation/llm-client.js');
        const status = llmClient.resetQuotas();
        console.log('LLM quotas reset:', status);
        showToast('success', 'Quotas Reset', `LLM quotas restored. Current provider: ${status.current}`);
      } catch (error) {
        console.error('Failed to reset quotas:', error);
        showToast('error', 'Reset Failed', error.message);
      }
    });

    // Preview button - open lesson in player
    $('#preview-btn').addEventListener('click', async () => {
      // Use the generated lesson from state
      const lesson = StateManager.get('lesson');
      if (!lesson) {
        showToast('error', 'No lesson', 'Please generate a lesson first');
        return;
      }

      // IMPORTANT: Blob URLs do NOT survive page navigation
      // When we navigate to player.html, the blob that created the URL is gone
      // We need to either:
      // 1. Store the blob itself in IndexedDB and recreate the URL on the player page
      // 2. Convert to a data URL (large but works)
      //
      // We'll use IndexedDB for efficiency with large audio files

      const audioState = StateManager.get('audio');
      const capturedAudioUrl = audioState?.url || null;

      console.log('=== AUDIO STATE DEBUG ===');
      console.log('audioState:', audioState);
      console.log('capturedAudioUrl:', capturedAudioUrl);

      if (capturedAudioUrl && capturedAudioUrl.startsWith('blob:')) {
        try {
          showToast('info', 'Preparing audio', 'Saving audio for playback...');

          // Fetch the blob from the blob URL
          const response = await fetch(capturedAudioUrl);
          const audioBlob = await response.blob();

          // Store the blob in IndexedDB
          await storeAudioBlobInIDB(lesson.id, audioBlob);

          // Mark the lesson as having stored audio
          lesson.audio = lesson.audio || {};
          lesson.audio.storedInIDB = true;
          lesson.audio.lessonId = lesson.id;

          console.log('Audio blob stored in IndexedDB for lesson:', lesson.id);
        } catch (error) {
          console.error('Failed to store audio blob:', error);
          // Continue without audio - at least the lesson will load
          showToast('warning', 'Audio save failed', 'Lesson will load without audio playback');
        }
      }

      // Save lesson to localStorage (without the blob URL which won't work anyway)
      // DEBUG: Log what we're saving
      console.log('=== PREVIEW BUTTON SAVING LESSON ===');
      console.log('Lesson structure being saved:', {
        id: lesson?.id,
        hasContent: !!lesson?.content,
        hasTranscript: !!lesson?.content?.transcript,
        transcriptSegments: lesson?.content?.transcript?.segments?.length || 0,
        transcriptText: lesson?.content?.transcript?.text?.substring(0, 100) || 'EMPTY',
        hasQuestions: !!lesson?.content?.questions,
        preQuestions: lesson?.content?.questions?.pre?.length || 0,
        whileQuestions: lesson?.content?.questions?.while?.length || 0,
        postQuestions: lesson?.content?.questions?.post?.length || 0,
        hasVocabulary: !!lesson?.content?.vocabulary,
        vocabularyItems: lesson?.content?.vocabulary?.items?.length || 0
      });
      localStorage.setItem('tanaghum_current_lesson', JSON.stringify(lesson));
      window.location.href = 'player.html';
    });

    /**
     * Store audio blob in IndexedDB for cross-page access
     * @param {string} lessonId - Lesson ID
     * @param {Blob} blob - Audio blob
     */
    async function storeAudioBlobInIDB(lessonId, blob) {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('TanaghulAudio', 1);

        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('audioBlobs')) {
            db.createObjectStore('audioBlobs', { keyPath: 'lessonId' });
          }
        };

        request.onsuccess = (event) => {
          const db = event.target.result;
          const tx = db.transaction('audioBlobs', 'readwrite');
          const store = tx.objectStore('audioBlobs');

          const data = {
            lessonId: lessonId,
            blob: blob,
            timestamp: Date.now()
          };

          const putRequest = store.put(data);

          putRequest.onsuccess = () => {
            db.close();
            resolve();
          };

          putRequest.onerror = () => {
            db.close();
            reject(putRequest.error);
          };
        };

        request.onerror = () => {
          reject(request.error);
        };
      });
    }

    // Export button - show export options
    let exportDialog = null;

    $('#export-btn').addEventListener('click', async () => {
      const lesson = StateManager.get('lesson');
      if (!lesson) {
        showToast('error', 'No lesson', 'Please generate a lesson first');
        return;
      }

      // Dynamically load export dialog
      if (!exportDialog) {
        try {
          const module = await import('./js/ui/export-dialog.js');
          exportDialog = module.exportDialog || new module.ExportDialog();
        } catch (error) {
          // Fallback to JSON export if export dialog fails to load
          console.error('Export dialog failed to load, using JSON fallback:', error);
          exportAsJson(lesson);
          return;
        }
      }

      exportDialog.show(lesson);
    });

    // Fallback JSON export function
    function exportAsJson(lesson) {
      const json = JSON.stringify(lesson, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      const timestamp = new Date().toISOString().split('T')[0];
      const title = (lesson.metadata?.title?.en || 'lesson').substring(0, 30).replace(/[^a-zA-Z0-9]/g, '-');
      a.download = `tanaghum-${title}-${timestamp}.json`;
      a.click();

      URL.revokeObjectURL(url);
      showToast('success', 'Exported', 'Lesson JSON downloaded');
    }

    // Create a lesson object for preview/export
    // createPreviewLesson removed - now using real lesson data from workflow

    // Toast notifications
    function showToast(type, title, message) {
      const container = $('#toast-container');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <div class="toast-content">
          <div class="toast-title">${escapeHtml(title)}</div>
          <div class="toast-message">${escapeHtml(message)}</div>
        </div>
        <button class="toast-close">&times;</button>
      `;

      container.appendChild(toast);

      toast.querySelector('.toast-close').addEventListener('click', () => {
        toast.remove();
      });

      setTimeout(() => toast.remove(), 4000);
    }

    /**
     * Estimate ILR level based on video metadata heuristics
     * Uses multiple signals: channel type, title keywords, topic domain,
     * video format, duration, and linguistic complexity indicators.
     *
     * ILR Scale Reference:
     * 1.0 - Elementary: Basic phrases, simple sentences
     * 1.5 - Elementary+: Simple conversations, routine topics
     * 2.0 - Limited Working: Factual discussions, straightforward narratives
     * 2.5 - Limited Working+: News broadcasts, formal speeches
     * 3.0 - General Professional: Complex analysis, technical discussions
     * 3.5 - General Professional+: Nuanced argumentation, sophisticated rhetoric
     */
    function estimateVideoIlr(video) {
      const title = (video.title || '');
      const titleLower = title.toLowerCase();
      const channel = (video.channel || '');
      const channelLower = channel.toLowerCase();
      const combined = titleLower + ' ' + channelLower;

      // Start with base score and modifiers
      let baseScore = 2.0;
      let modifiers = [];

      // ===========================================
      // CHANNEL-BASED SCORING (strongest signal)
      // ===========================================

      // Tier 1: Major News Networks - ILR 2.5-3.0 (Formal MSA, professional delivery)
      const majorNewsChannels = [
        'ÿßŸÑÿ¨ÿ≤Ÿäÿ±ÿ©', 'aljazeera', 'al jazeera',
        'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', 'alarabiya', 'al arabiya',
        'bbc ÿπÿ±ÿ®Ÿä', 'bbc arabic',
        'ŸÅÿ±ÿßŸÜÿ≥ 24', 'france 24',
        'ÿØŸàŸäÿ™ÿ¥Ÿá ŸÅŸäŸÑŸá', 'dw ÿπÿ±ÿ®Ÿä', 'dw arabic',
        'ÿ≥ŸÉÿßŸä ŸÜŸäŸàÿ≤ ÿπÿ±ÿ®Ÿäÿ©', 'sky news arabia',
        'ÿ±Ÿàÿ≥Ÿäÿß ÿßŸÑŸäŸàŸÖ', 'rt arabic',
        'ÿßŸÑÿ≠ÿ±ÿ©', 'alhurra',
        'ÿßŸÑŸÖŸÜÿßÿ±', 'manar',
        'ÿ™ŸÑŸÅÿ≤ŸäŸàŸÜ ÿ≥Ÿàÿ±Ÿäÿß', 'syria tv'
      ];
      if (majorNewsChannels.some(ch => combined.includes(ch))) {
        baseScore = 2.5;
        modifiers.push({ factor: 'major_news_channel', delta: 0 });
      }

      // Tier 2: Educational channels for learners - ILR 1.0-1.5
      const learnerChannels = [
        'learn arabic', 'ÿ™ÿπŸÑŸÖ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', 'arabic pod',
        'arabicpod', 'arabic 101', 'easy arabic',
        'arabic with', 'ÿπÿ±ÿ®Ÿä ŸÑŸÑŸÖÿ®ÿ™ÿØÿ¶ŸäŸÜ', 'beginner arabic',
        'madinah arabic', 'qasid', 'lingualism'
      ];
      if (learnerChannels.some(ch => combined.includes(ch))) {
        baseScore = 1.0;
        modifiers.push({ factor: 'learner_channel', delta: 0 });
      }

      // Tier 3: Children's content - ILR 1.0-1.5
      const kidsChannels = [
        'ÿ∑ŸäŸàÿ± ÿßŸÑÿ¨ŸÜÿ©', 'toyor al jannah', 'toyor baby',
        'ŸÉÿ±ÿßŸÖŸäÿ¥', 'karameesh', 'spacetoon',
        'mbc3', 'ÿ®ÿ±ÿßÿπŸÖ', 'baraem',
        'ÿ£ÿ∑ŸÅÿßŸÑ', 'kids', 'children', 'ŸÇŸÜÿßÿ© ÿßŸÑÿ£ÿ∑ŸÅÿßŸÑ',
        'ŸÉŸàŸÉŸä', 'ŸÉŸàŸÉŸà', 'ÿ≥ŸÖÿ≥ŸÖ', 'sesame'
      ];
      if (kidsChannels.some(ch => combined.includes(ch))) {
        baseScore = 1.0;
        modifiers.push({ factor: 'kids_channel', delta: 0 });
      }

      // Tier 4: Religious/Islamic content - varies widely, default 2.0-2.5
      const religiousChannels = [
        'ÿßŸÑÿ±ÿ≠ŸÖÿ©', 'ÿßŸÑŸÜÿßÿ≥', 'ÿßŸÇÿ±ÿ£', 'ÿßŸÑŸÖÿ¨ÿØ',
        'ÿ∑ÿ±ŸäŸÇ ÿßŸÑÿ•ÿ≥ŸÑÿßŸÖ', 'way of islam', 'islamweb',
        'ÿßŸÑÿ¥ŸäÿÆ', 'sheikh', 'imam',
        'quran', 'ŸÇÿ±ÿ¢ŸÜ', 'ÿ™ŸÑÿßŸàÿ©', 'recitation'
      ];
      if (religiousChannels.some(ch => combined.includes(ch))) {
        baseScore = 2.0;
        modifiers.push({ factor: 'religious_channel', delta: 0.25 });
      }

      // Tier 5: Academic/Think Tank channels - ILR 3.0+
      const academicChannels = [
        'brookings', 'carnegie', 'atlantic council',
        'ÿßŸÑŸÖÿ±ŸÉÿ≤ ÿßŸÑÿπÿ±ÿ®Ÿä', 'arab center',
        'ŸÖÿ±ŸÉÿ≤ ÿØÿ±ÿßÿ≥ÿßÿ™', 'research center',
        'ŸÖÿπŸáÿØ', 'institute', 'ÿ¨ÿßŸÖÿπÿ©', 'university',
        'ted', 'tedx'
      ];
      if (academicChannels.some(ch => combined.includes(ch))) {
        baseScore = 3.0;
        modifiers.push({ factor: 'academic_channel', delta: 0 });
      }

      // ===========================================
      // CONTENT TYPE INDICATORS
      // ===========================================

      // News broadcasts - formal, clear MSA
      const newsIndicators = [
        'ŸÜÿ¥ÿ±ÿ© ÿßŸÑÿ£ÿÆÿ®ÿßÿ±', 'news bulletin', 'breaking',
        'ÿπÿßÿ¨ŸÑ', 'ÿ£ÿÆÿ®ÿßÿ± ÿßŸÑŸäŸàŸÖ', 'today\'s news',
        'ŸÜÿ¥ÿ±ÿ©', 'ÿßŸÑÿ£ÿÆÿ®ÿßÿ±', 'ŸÖŸÑÿÆÿµ ÿßŸÑÿ£ÿÆÿ®ÿßÿ±'
      ];
      if (newsIndicators.some(kw => combined.includes(kw))) {
        modifiers.push({ factor: 'news_content', delta: 0.25 });
      }

      // Interviews - often complex with multiple speakers
      const interviewIndicators = [
        'ŸÖŸÇÿßÿ®ŸÑÿ©', 'interview', 'ŸÑŸÇÿßÿ°', 'ÿ≠Ÿàÿßÿ±',
        'ÿ∂ŸäŸÅ', 'guest', 'ÿßŸÑÿßÿ™ÿ¨ÿßŸá ÿßŸÑŸÖÿπÿßŸÉÿ≥',
        'ÿ®ŸÑÿß ÿ≠ÿØŸàÿØ', 'face to face'
      ];
      if (interviewIndicators.some(kw => combined.includes(kw))) {
        modifiers.push({ factor: 'interview', delta: 0.25 });
      }

      // Documentaries - typically well-produced, clear narration
      const docIndicators = [
        'Ÿàÿ´ÿßÿ¶ŸÇŸä', 'documentary', 'ÿ™ÿ≠ŸÇŸäŸÇ',
        'investigation', 'ÿßÿ≥ÿ™ŸÇÿµÿßÿ¶Ÿä',
        'ÿßŸÑÿ¨ÿ≤Ÿäÿ±ÿ© ÿßŸÑŸàÿ´ÿßÿ¶ŸÇŸäÿ©', 'nat geo', 'national geographic'
      ];
      if (docIndicators.some(kw => combined.includes(kw))) {
        modifiers.push({ factor: 'documentary', delta: 0.25 });
      }

      // Lectures/Academic talks - complex vocabulary, abstract concepts
      const lectureIndicators = [
        'ŸÖÿ≠ÿßÿ∂ÿ±ÿ©', 'lecture', 'ŸÜÿØŸàÿ©', 'seminar',
        'ŸÖÿ§ÿ™ŸÖÿ±', 'conference', 'symposium',
        'Ÿàÿ±ÿ¥ÿ© ÿπŸÖŸÑ', 'workshop', 'ÿØÿ±ÿ≥', 'lesson'
      ];
      if (lectureIndicators.some(kw => combined.includes(kw))) {
        modifiers.push({ factor: 'lecture', delta: 0.5 });
      }

      // Political analysis - sophisticated vocabulary
      const politicalIndicators = [
        'ÿ™ÿ≠ŸÑŸäŸÑ ÿ≥Ÿäÿßÿ≥Ÿä', 'political analysis',
        'ÿßŸÑŸàÿ∂ÿπ ÿßŸÑÿ≥Ÿäÿßÿ≥Ÿä', 'political situation',
        'ÿßŸÑÿπŸÑÿßŸÇÿßÿ™ ÿßŸÑÿØŸàŸÑŸäÿ©', 'international relations',
        'ÿßŸÑÿ≥Ÿäÿßÿ≥ÿ© ÿßŸÑÿÆÿßÿ±ÿ¨Ÿäÿ©', 'foreign policy',
        'ÿßŸÑÿµÿ±ÿßÿπ', 'conflict', 'ÿ£ÿ≤ŸÖÿ©', 'crisis',
        'ÿßŸÜÿ™ÿÆÿßÿ®ÿßÿ™', 'elections', 'ÿ®ÿ±ŸÑŸÖÿßŸÜ', 'parliament'
      ];
      if (politicalIndicators.some(kw => combined.includes(kw))) {
        modifiers.push({ factor: 'political_content', delta: 0.5 });
      }

      // Economic/Business content - technical vocabulary
      const economicIndicators = [
        'ÿßŸÑÿßŸÇÿ™ÿµÿßÿØ', 'economy', 'economic',
        'ÿßŸÑÿ®Ÿàÿ±ÿµÿ©', 'stock market', 'ÿ£ÿ≥ŸàÿßŸÇ ÿßŸÑŸÖÿßŸÑ',
        'ÿßŸÑÿ™ÿ∂ÿÆŸÖ', 'inflation', 'ÿßŸÑŸÜÿßÿ™ÿ¨ ÿßŸÑŸÖÿ≠ŸÑŸä', 'gdp',
        'ÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±', 'investment', 'ÿ™ÿ¨ÿßÿ±ÿ©', 'trade',
        'ÿ®ŸÜŸÉ', 'bank', 'ÿπŸÖŸÑÿ©', 'currency'
      ];
      if (economicIndicators.some(kw => combined.includes(kw))) {
        modifiers.push({ factor: 'economic_content', delta: 0.25 });
      }

      // Cultural/Historical content - can vary widely
      const culturalIndicators = [
        'ÿ™ÿ±ÿßÿ´', 'heritage', 'ÿ´ŸÇÿßŸÅÿ©', 'culture',
        'ÿ™ÿßÿ±ŸäÿÆ', 'history', 'ÿ≠ÿ∂ÿßÿ±ÿ©', 'civilization',
        'ŸÅŸÜ', 'art', 'ŸÖŸàÿ≥ŸäŸÇŸâ', 'music',
        'ÿ£ÿØÿ®', 'literature', 'ÿ¥ÿπÿ±', 'poetry'
      ];
      if (culturalIndicators.some(kw => combined.includes(kw))) {
        modifiers.push({ factor: 'cultural_content', delta: 0.25 });
      }

      // Sports - usually simpler, informal
      const sportsIndicators = [
        'ÿ±Ÿäÿßÿ∂ÿ©', 'sports', 'ŸÉÿ±ÿ© ÿßŸÑŸÇÿØŸÖ', 'football',
        'ŸÖÿ®ÿßÿ±ÿßÿ©', 'match', 'ÿØŸàÿ±Ÿä', 'league',
        'ŸÉÿ£ÿ≥ ÿßŸÑÿπÿßŸÑŸÖ', 'world cup', 'ÿ£ŸáÿØÿßŸÅ', 'goals',
        'ŸÖŸÑÿÆÿµ ÿßŸÑŸÖÿ®ÿßÿ±ÿßÿ©', 'match summary'
      ];
      if (sportsIndicators.some(kw => combined.includes(kw))) {
        modifiers.push({ factor: 'sports_content', delta: -0.25 });
      }

      // Science/Technology - technical but often explained
      const scienceIndicators = [
        'ÿπŸÑŸàŸÖ', 'science', 'ÿ™ŸÉŸÜŸàŸÑŸàÿ¨Ÿäÿß', 'technology',
        'ŸÅÿ∂ÿßÿ°', 'space', 'ÿ∑ÿ®', 'medicine',
        'ÿßÿÆÿ™ÿ±ÿßÿπ', 'invention', 'ÿßŸÉÿ™ÿ¥ÿßŸÅ', 'discovery',
        'ÿ∞ŸÉÿßÿ° ÿßÿµÿ∑ŸÜÿßÿπŸä', 'ai', 'artificial intelligence'
      ];
      if (scienceIndicators.some(kw => combined.includes(kw))) {
        modifiers.push({ factor: 'science_content', delta: 0.25 });
      }

      // ===========================================
      // COMPLEXITY INDICATORS (in title)
      // ===========================================

      // Simple/Beginner indicators - lower score
      const simpleIndicators = [
        'ÿ≥ŸáŸÑ', 'easy', 'ÿ®ÿ≥Ÿäÿ∑', 'simple',
        'ŸÑŸÑŸÖÿ®ÿ™ÿØÿ¶ŸäŸÜ', 'for beginners', 'ŸÖÿ®ÿ≥ÿ∑', 'simplified',
        'ÿ¥ÿ±ÿ≠', 'explanation', 'ŸÖŸÑÿÆÿµ', 'summary',
        'ŸÅŸä ÿØŸÇÿßÿ¶ŸÇ', 'in minutes', 'ŸÖÿÆÿ™ÿµÿ±', 'brief'
      ];
      if (simpleIndicators.some(kw => combined.includes(kw))) {
        modifiers.push({ factor: 'simple_indicator', delta: -0.5 });
      }

      // Complex/Advanced indicators - higher score
      const complexIndicators = [
        'ÿ™ÿ≠ŸÑŸäŸÑ ŸÖÿπŸÖŸÇ', 'deep analysis', 'ÿØÿ±ÿßÿ≥ÿ©',
        'ŸÖÿ™ŸÇÿØŸÖ', 'advanced', 'ÿ™ŸÅÿµŸäŸÑŸä', 'detailed',
        'ÿ¥ÿßŸÖŸÑ', 'comprehensive', 'ŸÖŸàÿ≥ÿπ', 'extended',
        'ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑÿ£ŸàŸÑ', 'part 1', 'ÿ≥ŸÑÿ≥ŸÑÿ©', 'series'
      ];
      if (complexIndicators.some(kw => combined.includes(kw))) {
        modifiers.push({ factor: 'complex_indicator', delta: 0.5 });
      }

      // ===========================================
      // DIALECT INDICATORS
      // ===========================================

      // Dialectal content often less formal
      const dialectIndicators = [
        'ŸÖÿµÿ±Ÿä', 'egyptian', 'ŸÑŸáÿ¨ÿ© ŸÖÿµÿ±Ÿäÿ©',
        'ÿ¥ÿßŸÖŸä', 'levantine', 'ÿ≥Ÿàÿ±Ÿä', 'syrian',
        'ÿÆŸÑŸäÿ¨Ÿä', 'gulf', 'ÿ•ŸÖÿßÿ±ÿßÿ™Ÿä', 'ÿ≥ÿπŸàÿØŸä',
        'ŸÖÿ∫ÿ±ÿ®Ÿä', 'moroccan', 'ÿ¨ÿ≤ÿßÿ¶ÿ±Ÿä', 'algerian',
        'ÿπÿßŸÖŸäÿ©', 'colloquial', 'ŸÑŸáÿ¨ÿ©', 'dialect'
      ];
      if (dialectIndicators.some(kw => combined.includes(kw))) {
        modifiers.push({ factor: 'dialect_content', delta: -0.25 });
      }

      // Formal MSA indicators
      const msaIndicators = [
        'ŸÅÿµÿ≠Ÿâ', 'fusha', 'ŸÅÿµŸäÿ≠', 'classical',
        'ÿπÿ±ÿ®Ÿäÿ© ŸÅÿµÿ≠Ÿâ', 'standard arabic',
        'ŸÑÿ∫ÿ© ÿπÿ±ÿ®Ÿäÿ©', 'arabic language'
      ];
      if (msaIndicators.some(kw => combined.includes(kw))) {
        modifiers.push({ factor: 'formal_msa', delta: 0.25 });
      }

      // ===========================================
      // DURATION-BASED ADJUSTMENTS
      // ===========================================

      const duration = video.durationSeconds || 0;

      // Very short clips (<2 min) - often simpler content or snippets
      if (duration > 0 && duration < 120) {
        modifiers.push({ factor: 'very_short', delta: -0.25 });
      }

      // Long-form content (>15 min) - usually more comprehensive
      if (duration > 900) {
        modifiers.push({ factor: 'long_form', delta: 0.25 });
      }

      // Very long lectures (>45 min) - likely academic
      if (duration > 2700) {
        modifiers.push({ factor: 'very_long', delta: 0.25 });
      }

      // ===========================================
      // CALCULATE FINAL SCORE
      // ===========================================

      let finalScore = baseScore;
      for (const mod of modifiers) {
        finalScore += mod.delta;
      }

      // Clamp to valid ILR range
      finalScore = Math.min(3.5, Math.max(1.0, finalScore));

      // Round to nearest 0.5
      finalScore = Math.round(finalScore * 2) / 2;

      // Debug logging (can be removed in production)
      console.log(`ILR estimate for "${title.substring(0, 50)}...":`, {
        baseScore,
        modifiers: modifiers.map(m => `${m.factor}: ${m.delta > 0 ? '+' : ''}${m.delta}`),
        finalScore
      });

      return finalScore;
    }

    // Smart Search functionality
    const searchQuery = $('#search-query');
    const searchBtn = $('#search-btn');
    const searchResults = $('#search-results');
    const searchResultsGrid = $('#search-results-grid');
    const searchResultsCount = $('#search-results-count');
    const searchLoading = $('#search-loading');
    const searchLoadingText = $('#search-loading-text');
    const clearSearchBtn = $('#clear-search');

    // Import LLM client for AI evaluation (lazy load)
    let llmClient = null;
    let currentSearchController = null;

    async function loadLLMClient() {
      if (!llmClient) {
        const module = await import('./js/generation/llm-client.js');
        llmClient = module.llmClient;
      }
      return llmClient;
    }

    // Duration filter state
    let durationFilter = { min: 0, max: 0 };

    async function performSearch(queryOverride = null) {
      // Cancel any existing search
      if (currentSearchController) {
        currentSearchController.abort();
      }
      currentSearchController = new AbortController();

      const query = queryOverride || (searchQuery?.value?.trim() || '');
      if (!query) {
        showToast('error', 'Empty search', 'Please enter a search term');
        return;
      }

      // Show loading state
      searchLoading.classList.remove('hidden');
      searchLoadingText.textContent = 'Searching YouTube...';
      searchResults.classList.add('hidden');
      if (searchBtn) searchBtn.disabled = true;

      try {
        // Build search URL with duration filter
        let searchUrl = `${Config.WORKER_URL}/api/youtube/search?q=${encodeURIComponent(query)}`;
        if (durationFilter.min > 0) searchUrl += `&minDuration=${durationFilter.min}`;
        if (durationFilter.max > 0) searchUrl += `&maxDuration=${durationFilter.max}`;

        // Get search results (no AI evaluation - saves requests)
        const response = await fetch(
          searchUrl,
          { signal: currentSearchController.signal }
        );
        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        const videos = data.videos || [];
        displaySearchResults(videos, false);

        if (videos.length > 0) {
          showToast('success', 'Videos found', `${videos.length} videos available`);
        }

      } catch (error) {
        if (error.name === 'AbortError') {
          console.log('Search aborted');
          return;
        }
        console.error('Search failed:', error);
        showToast('error', 'Search failed', error.message || 'Could not search YouTube');
      } finally {
        searchLoading.classList.add('hidden');
        if (searchBtn) searchBtn.disabled = false;
        currentSearchController = null;
      }
    }

    function displaySearchResults(videos) {
      if (videos.length === 0) {
        searchResultsCount.textContent = 'No videos found';
        searchResultsGrid.innerHTML = '<p style="text-align: center; color: var(--color-text-muted); padding: 20px;">Try a different topic</p>';
        searchResults.classList.remove('hidden');
        return;
      }

      searchResultsCount.textContent = `${videos.length} videos found`;

      // Get current target ILR for display
      const targetIlr = StateManager.get('params.targetIlr') || 2.0;

      searchResultsGrid.innerHTML = videos.map(video => {
        // Estimate ILR based on channel/title heuristics
        const estimatedIlr = estimateVideoIlr(video);
        const ilrMatch = Math.abs(estimatedIlr - targetIlr) <= 0.5;

        return `
          <div class="video-search-card ${ilrMatch ? 'recommended' : ''}"
               data-video-id="${escapeHtml(video.videoId)}"
               data-video='${JSON.stringify(video).replace(/'/g, "&#39;")}'
               data-estimated-ilr="${estimatedIlr}">
            <img class="video-thumb-small" src="${escapeHtml(video.thumbnail)}" alt="${escapeHtml(video.title)}" loading="lazy">
            <div class="video-info">
              <h4>${escapeHtml(video.title)}</h4>
              <div class="video-channel">${escapeHtml(video.channel)}</div>
              <div class="video-meta-row">
                <span>${escapeHtml(video.duration || '')}</span>
                <span>${escapeHtml(video.views || '')}</span>
                <span class="ilr-badge estimated" title="Estimated ILR level">~${estimatedIlr.toFixed(1)}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');

      searchResults.classList.remove('hidden');

      // Add click handlers to select videos
      searchResultsGrid.querySelectorAll('.video-search-card').forEach(card => {
        card.addEventListener('click', () => selectSearchResult(card));
      });
    }

    async function selectSearchResult(card) {
      const videoId = card.dataset.videoId;
      const videoData = JSON.parse(card.dataset.video);
      const estimatedIlr = parseFloat(card.dataset.estimatedIlr) || 2.0;

      // Mark as selected
      searchResultsGrid.querySelectorAll('.video-search-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');

      // Update state
      StateManager.set('source', {
        type: 'youtube',
        url: `https://www.youtube.com/watch?v=${videoId}`,
        videoId: videoId,
        estimatedIlr: estimatedIlr,
        metadata: {
          title: videoData.title,
          author: videoData.channel,
          thumbnail: videoData.thumbnail,
          duration: videoData.durationSeconds,
          captions: { available: false } // Will check when processing
        }
      });

      // Show preview in main content area
      showVideoPreview({
        videoId: videoId,
        title: videoData.title,
        author: videoData.channel,
        thumbnail: videoData.thumbnail,
        duration: videoData.durationSeconds,
        captions: { available: false }
      });

      // Get target ILR for match message
      const targetIlr = StateManager.get('params.targetIlr') || 2.0;
      const isMatch = Math.abs(estimatedIlr - targetIlr) <= 0.5;
      const matchMsg = isMatch
        ? `Good match for ILR ${targetIlr.toFixed(1)}`
        : `Estimated ILR ${estimatedIlr.toFixed(1)}`;

      showToast('success', 'Video selected', matchMsg);
    }

    // Search on button click (custom search)
    searchBtn?.addEventListener('click', () => {
      const query = searchQuery?.value?.trim();
      if (query) performSearch(query);
    });

    // Search on Enter key
    searchQuery?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        performSearch();
      }
    });

    // Clear search results
    clearSearchBtn?.addEventListener('click', () => {
      if (searchQuery) searchQuery.value = '';
      searchResults.classList.add('hidden');
      searchResultsGrid.innerHTML = '';
      // Clear active topic
      document.querySelectorAll('.topic-btn').forEach(b => b.classList.remove('active'));
    });

    // Topic search queries
    const topicQueries = {
      news: 'ÿ£ÿÆÿ®ÿßÿ± ÿπÿ±ÿ®Ÿäÿ© arabic news',
      politics: 'ÿ≥Ÿäÿßÿ≥ÿ© ÿπÿ±ÿ®Ÿäÿ© ŸÖŸÇÿßÿ®ŸÑÿ© arabic politics interview',
      economy: 'ÿßŸÇÿ™ÿµÿßÿØ ÿπÿ±ÿ®Ÿä arabic economy business',
      culture: 'ÿ´ŸÇÿßŸÅÿ© ÿπÿ±ÿ®Ÿäÿ© ÿ™ÿ±ÿßÿ´ arabic culture documentary',
      sports: 'ÿ±Ÿäÿßÿ∂ÿ© ÿπÿ±ÿ®Ÿäÿ© ŸÉÿ±ÿ© ÿßŸÑŸÇÿØŸÖ arabic sports',
      science: 'ÿπŸÑŸàŸÖ ÿπÿ±ÿ®Ÿäÿ© Ÿàÿ´ÿßÿ¶ŸÇŸä arabic science documentary',
      religion: 'ÿ•ÿ≥ŸÑÿßŸÖ ÿØŸäŸÜ ÿπÿ±ÿ®Ÿä arabic islam religion',
      history: 'ÿ™ÿßÿ±ŸäÿÆ ÿπÿ±ÿ®Ÿä Ÿàÿ´ÿßÿ¶ŸÇŸä arabic history documentary',
      health: 'ÿµÿ≠ÿ© ÿπÿ±ÿ®Ÿä ÿ∑ÿ®Ÿä arabic health medical',
      education: 'ÿ™ÿπŸÑŸäŸÖ ÿπÿ±ÿ®Ÿä arabic education learning'
    };

    // Perform search based on topic dropdown selection
    function performTopicSearch(topic) {
      if (!topic) return;
      const query = topicQueries[topic] || topic;
      performSearch(query);
    }

    // Stop search button
    $('#stop-search-btn')?.addEventListener('click', () => {
      if (currentSearchController) {
        currentSearchController.abort();
        currentSearchController = null;
      }
      searchLoading.classList.add('hidden');
      showToast('info', 'Search stopped', 'Search was cancelled');
    });

    // Duration filter buttons
    document.querySelectorAll('.duration-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        // Update active state
        document.querySelectorAll('.duration-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // Update filter state
        durationFilter.min = parseInt(btn.dataset.min) || 0;
        durationFilter.max = parseInt(btn.dataset.max) || 0;

        // Re-run search if there's a selected topic
        const selectedTopic = topicSelect?.value;
        if (selectedTopic) {
          performTopicSearch(selectedTopic);
        }
      });
    });

    // Mobile panel switching
    document.querySelectorAll('.mobile-toolbar-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.mobile-toolbar-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        const panel = btn.dataset.panel;
        const configPanel = $('#config-panel');
        const statusPanel = $('#status-panel');
        const mainContent = $('.main-content');

        // Close all panels first
        configPanel.classList.remove('mobile-open');
        statusPanel.classList.remove('mobile-open');
        mainContent.classList.remove('mobile-hidden');

        // Open the selected panel
        if (panel === 'config') {
          configPanel.classList.add('mobile-open');
          mainContent.classList.add('mobile-hidden');
        } else if (panel === 'status') {
          statusPanel.classList.add('mobile-open');
          mainContent.classList.add('mobile-hidden');
        }
        // 'main' panel shows the main content (default state)
      });
    });

    // Listen for model loading events
    EventBus.on(Events.MODEL_LOADING, (data) => {
      if (data.model === 'whisper') {
        const message = data.file ? `Loading: ${data.file}` : 'Loading Whisper model...';
        const percent = data.progress || 0;
        console.log(`Whisper model loading: ${percent}% - ${message}`);
      }
    });

    EventBus.on(Events.MODEL_READY, (data) => {
      if (data.model === 'whisper') {
        console.log('Whisper model ready');
      }
    });

    EventBus.on(Events.MODEL_ERROR, (data) => {
      if (data.model === 'whisper') {
        console.error('Whisper model error:', data.error);
        showToast('error', 'Model Error', data.error);
      }
    });

    // Listen for transcription events
    EventBus.on(Events.TRANSCRIPTION_PROGRESS, (data) => {
      console.log(`Transcription: ${data.progress}%`);
    });

    // Listen for LLM quota updates
    EventBus.on(Events.LLM_QUOTA_UPDATE, (quotas) => {
      console.log('LLM quotas updated:', quotas);

      const limits = { google: 1500, groq: 14400, openrouter: 50 };

      for (const [provider, remaining] of Object.entries(quotas)) {
        const limit = limits[provider] || 100;
        const fillEl = $(`#quota-fill-${provider}`);
        const textEl = $(`#quota-text-${provider}`);

        if (fillEl) {
          const percent = Math.round((remaining / limit) * 100);
          fillEl.style.width = `${percent}%`;

          // Color based on remaining
          if (percent <= 10) {
            fillEl.style.backgroundColor = 'var(--color-error)';
          } else if (percent <= 30) {
            fillEl.style.backgroundColor = 'var(--color-warning)';
          } else {
            fillEl.style.backgroundColor = '';
          }
        }

        if (textEl) {
          textEl.textContent = `${remaining.toLocaleString()} / ${limit.toLocaleString()} requests remaining`;
        }

        // Update status indicator dot color
        const card = document.querySelector(`.status-card[data-provider="${provider}"]`);
        const dot = card?.querySelector('.status-indicator');
        if (dot) {
          const percent = Math.round((remaining / limit) * 100);
          dot.style.backgroundColor = percent <= 0 ? 'var(--color-error)' : percent <= 20 ? 'var(--color-warning)' : '';
        }
      }
    });

    // Preview Generate button (in center column)
    $('#preview-generate-btn')?.addEventListener('click', () => {
      startGeneration();
    });

    // Preview Change button (clear selection)
    $('#preview-change-btn')?.addEventListener('click', () => {
      hideVideoPreview();
      // Clear the source videoId but keep type
      StateManager.set('source.videoId', null);
      StateManager.set('source.url', null);
      StateManager.set('source.metadata', null);
      // Clear selection highlight
      searchResultsGrid?.querySelectorAll('.video-search-card').forEach(c => c.classList.remove('selected'));
    });

    // Initialize - restore session if available, else default to search/discovery mode
    (function initializeSession() {
      const restored = StateManager.restoreSession();
      if (restored) {
        console.log('Session restored from previous work');
        const state = StateManager.get();

        // Restore UI state from session
        if (state.source?.type) {
          // Set correct source dropdown value
          if (sourceSelect) sourceSelect.value = state.source.type;
          sourceContents.forEach(content => {
            content.classList.toggle('hidden', !content.id.includes(state.source.type));
          });
        }

        // Restore topic if set
        if (state.params?.topic && topicSelect) {
          topicSelect.value = state.params.topic;
        }

        // If we have a lesson, show it in the review state
        if (state.lesson) {
          console.log('Restored lesson:', state.lesson.metadata?.title);
          // Show the review state with the restored lesson
          $('#input-state').classList.add('hidden');
          $('#processing-state').classList.add('hidden');
          $('#review-state').classList.remove('hidden');

          // Update step indicator
          document.querySelectorAll('.step').forEach(step => {
            step.classList.remove('active');
            step.classList.add('completed');
          });
          document.querySelector('[data-step="3"]').classList.add('active');
          document.querySelector('[data-step="3"]').classList.remove('completed');

          // Enable buttons
          $('#back-btn').disabled = false;
          $('#preview-btn').disabled = false;
          $('#export-btn').disabled = false;

          // Populate the lesson data
          populateLessonData(state.lesson);
          showToast('info', 'Session Restored', 'Your previous lesson has been restored.');
        }
      } else {
        // Default to search/discovery mode
        StateManager.set('source.type', 'search');
        // Ensure dropdown and content panels are synced
        if (sourceSelect) sourceSelect.value = 'search';
        sourceContents.forEach(content => {
          content.classList.toggle('hidden', !content.id.includes('search'));
        });
      }
    })();

    // Mobile initialization - show Config panel by default
    function initMobileView() {
      const isMobile = window.innerWidth <= 768;
      if (isMobile) {
        $('#config-panel').classList.add('mobile-open');
        $('.main-content').classList.add('mobile-hidden');
      }
    }

    // Auto-navigate to Content when video is selected (mobile)
    function autoNavigateOnSelection() {
      const isMobile = window.innerWidth <= 768;
      if (isMobile) {
        // Switch to Content view
        document.querySelectorAll('.mobile-toolbar-btn').forEach(b => b.classList.remove('active'));
        document.querySelector('[data-panel="main"]').classList.add('active');
        $('#config-panel').classList.remove('mobile-open');
        $('#status-panel').classList.remove('mobile-open');
        $('.main-content').classList.remove('mobile-hidden');
      }
    }

    // Hook into video selection to auto-navigate
    const originalSelectSearchResult = selectSearchResult;
    selectSearchResult = async function(card) {
      await originalSelectSearchResult(card);
      autoNavigateOnSelection();
    };

    // Run mobile init
    initMobileView();
    window.addEventListener('resize', () => {
      // Reset mobile classes if switching to desktop
      if (window.innerWidth > 768) {
        $('#config-panel').classList.remove('mobile-open');
        $('#status-panel').classList.remove('mobile-open');
        $('.main-content').classList.remove('mobile-hidden');
      }
    });

    // Initialize quota display from stored state
    (async () => {
      try {
        const { llmClient } = await import('./js/generation/llm-client.js');
        const status = llmClient.getQuotaStatus();
        EventBus.emit(Events.LLM_QUOTA_UPDATE, status.quotas);
      } catch (e) {
        console.warn('Could not initialize quota display:', e);
      }
    })();

    console.log('Tanaghum Generator initialized');
  </script>
</body>
</html>
